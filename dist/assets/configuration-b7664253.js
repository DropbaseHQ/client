import{_ as E,h as f,R as Le,I as ct,a5 as Tt,af as Lt,hF as Nt,B as te,y as zt,bu as ut,hG as jt,dr as ht,hH as $t,hI as Se,hJ as lt,hK as dt,dE as Ne,aQ as Vt,hL as ft,dF as Kt,dC as qt,hM as Ht,a2 as ve,a3 as Bt,hN as Gt,hO as Jt,a0 as gt,bv as Yt,a1 as Xt,$ as Qt,hP as Ke,hQ as Zt,hR as ei,cl as ti,fd as ii,hS as ri}from"./index-5b71d1bd.js";import{g0 as si,cV as ce,qW as M,qX as w,eT as ni,qY as pt,bW as q,b8 as ze,bn as T,bz as G,be as O,da as oi,cK as Ct,bf as ge,d5 as je,d6 as ai,d7 as qe,d8 as ci,av as u,fJ as X,d9 as ui,aW as y,dm as P,g1 as Z,c5 as ie,qZ as wt,c9 as hi,q_ as li,cv as di,al as kt,aM as k,aD as S,aP as He,q$ as fi,aO as $e,eh as Be,br as R,b0 as gi,b6 as St,h9 as vt,aR as mt,bV as pi,cx as yt,cw as H,jg as bt,hN as Ci,r0 as wi,r1 as J,r2 as L,r3 as W,r4 as Ge,r5 as Y,r6 as ki,r7 as Si,dO as Wt,r8 as _t,eZ as vi,dp as Je,r9 as mi,ra as yi,rb as bi,ae as U,rc as ee,af as A,qF as ue,rd as me,re as Wi,aU as Ye,pc as _i,aS as N,fy as Ri,aQ as Fi,f_ as z,rf as Xe,cG as Di,rg as Pi,g2 as Ei,f$ as Ii,ca as Oi,cb as Ui,du as xi,aa as pe,cm as Rt,dq as Ft,gX as Ai,bi as Qe,a8 as D,bN as Mi,rh as Ti,bI as Dt,bm as x,dD as Li,bl as ye,pb as Ni,qG as Pt,jf as Fe,ig as se,bk as he,cP as V,bJ as zi,ri as ji,aZ as Et,iC as $i,ku as Vi,rj as Ki,ie as qi,rk as Hi,rl as Ze,df as Bi,cq as Gi,bM as De,bt as Ji,rm as Yi,fg as B,fi as Xi,fu as j,cl as Qi,aY as Zi,ai as er}from"./vendor-332432be.js";import{T as _,L as $,a as tr,F as It,b as ir,U as rr,W as sr,R as be,c as ne,d as Pe,e as nr,u as or,p as ar,m as cr,w as Ot,f as ur,g as hr,h as lr,i as dr,P as fr,I as gr,l as pr,t as Cr}from"./configuration-e4f2850d.js";class le extends M{constructor(e){super(e),this._folders=[],this._transient=!1,this._settingsModelParser=new M(e),this._launchModel=new w,this._tasksModel=new w}get folders(){return this._folders}get transient(){return this._transient}get settingsModel(){return this._settingsModelParser.configurationModel}get launchModel(){return this._launchModel}get tasksModel(){return this._tasksModel}reparseWorkspaceSettings(e){this._settingsModelParser.reparse(e)}getRestrictedWorkspaceSettings(){return this._settingsModelParser.restrictedConfigurations}doParseRaw(e,t){return this._folders=e.folders||[],this._transient=ni(e.transient)&&e.transient,this._settingsModelParser.parseRaw(e.settings,t),this._launchModel=this.createConfigurationModelFrom(e,"launch"),this._tasksModel=this.createConfigurationModelFrom(e,"tasks"),super.doParseRaw(e,t)}createConfigurationModelFrom(e,t){const i=e[t];if(i){const r=pt(i,o=>console.error(`Conflict in settings file ${this._name}: ${o}`)),n=Object.create(null);n[t]=r;const s=Object.keys(i).map(o=>`${t}.${o}`);return new w(n,s,[])}return new w}}class Ut extends M{constructor(e,t){super(e),this.scope=t}doParseRaw(e,t){const i=pt(e,s=>console.error(`Conflict in settings file ${this._name}: ${s}`)),r=Object.create(null);r[this.scope]=i;const n=Object.keys(e).map(s=>`${this.scope}.${s}`);return{contents:r,keys:n,overrides:[]}}}class et extends si{constructor(e,t,i,r,n,s,o,a,c,h){super(e,t,i,r,n,s,o,a,c),this._workspace=h}getValue(e,t={}){return super.getValue(e,t,this._workspace)}inspect(e,t={}){return super.inspect(e,t,this._workspace)}keys(){return super.keys(this._workspace)}compareAndDeleteFolderConfiguration(e){return this._workspace&&this._workspace.folders.length>0&&this._workspace.folders[0].uri.toString()===e.toString()?{keys:[],overrides:[]}:super.compareAndDeleteFolderConfiguration(e)}compare(e){const t=(s,o,a)=>{const c=[];return c.push(...o.filter(h=>s.indexOf(h)===-1)),c.push(...s.filter(h=>o.indexOf(h)===-1)),c.push(...s.filter(h=>o.indexOf(h)===-1?!1:q(this.getValue(h,{overrideIdentifier:a}),e.getValue(h,{overrideIdentifier:a}))?this._workspace&&this._workspace.folders.some(d=>!q(this.getValue(h,{resource:d.uri,overrideIdentifier:a}),e.getValue(h,{resource:d.uri,overrideIdentifier:a}))):!0)),c},i=t(this.allKeys(),e.allKeys()),r=[],n=ce([...this.allOverrideIdentifiers(),...e.allOverrideIdentifiers()]);for(const s of n){const o=t(this.getAllKeysForOverrideIdentifier(s),e.getAllKeysForOverrideIdentifier(s),s);o.length&&r.push([s,o])}return{keys:i,overrides:r}}}class wr extends Error{constructor(e,t){super(e),this.code=t}}let Ee=class{constructor(e,t,i,r,n,s,o,a,c,h,d,p){this.remoteSettingsResource=e,this.configurationService=t,this.contextService=i,this.userDataProfileService=r,this.userDataProfilesService=n,this.fileService=s,this.textModelResolverService=o,this.textFileService=a,this.notificationService=c,this.preferencesService=h,this.editorService=d,this.uriIdentityService=p,this.queue=new je}async writeConfiguration(e,t,i={}){const r=this.getConfigurationEditOperation(e,t,i.scopes||{});return this.queue.queue(async()=>{try{await this.doWriteConfiguration(r,i)}catch(n){if(i.donotNotifyError)throw n;await this.onError(n,r,i.scopes)}})}async doWriteConfiguration(e,t){await this.validate(e.target,e,!t.handleDirtyFile,t.scopes||{});const i=e.resource,r=await this.resolveModelReference(i);try{const n=this.getFormattingOptions(r.object.textEditorModel);await this.updateConfiguration(e,r.object.textEditorModel,n,t)}finally{r.dispose()}}async updateConfiguration(e,t,i,r){if(this.hasParseErrors(t.getValue(),e))throw this.toConfigurationEditingError(11,e.target,e);if(this.textFileService.isDirty(t.uri)&&r.handleDirtyFile)switch(r.handleDirtyFile){case"save":await this.save(t,e);break;case"revert":await this.textFileService.revert(t.uri);break}const n=this.getEdits(e,t.getValue(),i)[0];n&&this.applyEditsToBuffer(n,t)&&await this.save(t,e)}async save(e,t){try{await this.textFileService.save(e.uri,{ignoreErrorHandler:!0})}catch(i){throw i.fileOperationResult===3?this.toConfigurationEditingError(10,t.target,t):this.toConfigurationEditingError(13,t.target,t)}}applyEditsToBuffer(e,t){const i=t.getPositionAt(e.offset),r=t.getPositionAt(e.offset+e.length),n=new ai(i.lineNumber,i.column,r.lineNumber,r.column),s=t.getValueInRange(n);if(e.content!==s){const o=s?qe.replace(n,e.content):qe.insert(i,e.content);return t.pushEditOperations([new ci(i.lineNumber,i.column,i.lineNumber,i.column)],[o],()=>[]),!0}return!1}getEdits({value:e,jsonPath:t},i,r){return t.length?Nt(i,t,e,r):[{content:JSON.stringify(e,null,r.insertSpaces&&r.tabSize?" ".repeat(r.tabSize):"	"),length:i.length,offset:0}]}getFormattingOptions(e){const{insertSpaces:t,tabSize:i}=e.getOptions(),r=e.getEOL();return{insertSpaces:t,tabSize:i,eol:r}}async onError(e,t,i){switch(e.code){case 11:this.onInvalidConfigurationError(e,t);break;case 9:this.onConfigurationFileDirtyError(e,t,i);break;case 10:return this.doWriteConfiguration(t,{scopes:i,handleDirtyFile:"revert"});default:this.notificationService.error(e.message)}}onInvalidConfigurationError(e,t){const i=t.workspaceStandAloneConfigurationKey===_?u("openTasksConfiguration","Open Tasks Configuration"):t.workspaceStandAloneConfigurationKey===$?u("openLaunchConfiguration","Open Launch Configuration"):null;i?this.notificationService.prompt(X.Error,e.message,[{label:i,run:()=>this.openFile(t.resource)}]):this.notificationService.prompt(X.Error,e.message,[{label:u("open","Open Settings"),run:()=>this.openSettings(t)}])}onConfigurationFileDirtyError(e,t,i){const r=t.workspaceStandAloneConfigurationKey===_?u("openTasksConfiguration","Open Tasks Configuration"):t.workspaceStandAloneConfigurationKey===$?u("openLaunchConfiguration","Open Launch Configuration"):null;r?this.notificationService.prompt(X.Error,e.message,[{label:u("saveAndRetry","Save and Retry"),run:()=>{const n=t.key?`${t.workspaceStandAloneConfigurationKey}.${t.key}`:t.workspaceStandAloneConfigurationKey;this.writeConfiguration(t.target,{key:n,value:t.value},{handleDirtyFile:"save",scopes:i})}},{label:r,run:()=>this.openFile(t.resource)}]):this.notificationService.prompt(X.Error,e.message,[{label:u("saveAndRetry","Save and Retry"),run:()=>this.writeConfiguration(t.target,{key:t.key,value:t.value},{handleDirtyFile:"save",scopes:i})},{label:u("open","Open Settings"),run:()=>this.openSettings(t)}])}openSettings(e){const t={jsonEditor:!0};switch(e.target){case 1:this.preferencesService.openUserSettings(t);break;case 2:this.preferencesService.openRemoteSettings(t);break;case 3:this.preferencesService.openWorkspaceSettings(t);break;case 4:if(e.resource){const i=this.contextService.getWorkspaceFolder(e.resource);i&&this.preferencesService.openFolderSettings({folderUri:i.uri,jsonEditor:!0})}break}}openFile(e){this.editorService.openEditor({resource:e,options:{pinned:!0}})}toConfigurationEditingError(e,t,i){const r=this.toErrorMessage(e,t,i);return new wr(r,e)}toErrorMessage(e,t,i){switch(e){case 12:return u("errorPolicyConfiguration","Unable to write {0} because it is configured in system policy.",i.key);case 0:return u("errorUnknownKey","Unable to write to {0} because {1} is not a registered configuration.",this.stringifyTarget(t),i.key);case 1:return u("errorInvalidWorkspaceConfigurationApplication","Unable to write {0} to Workspace Settings. This setting can be written only into User settings.",i.key);case 2:return u("errorInvalidWorkspaceConfigurationMachine","Unable to write {0} to Workspace Settings. This setting can be written only into User settings.",i.key);case 3:return u("errorInvalidFolderConfiguration","Unable to write to Folder Settings because {0} does not support the folder resource scope.",i.key);case 4:return u("errorInvalidUserTarget","Unable to write to User Settings because {0} does not support for global scope.",i.key);case 5:return u("errorInvalidWorkspaceTarget","Unable to write to Workspace Settings because {0} does not support for workspace scope in a multi folder workspace.",i.key);case 6:return u("errorInvalidFolderTarget","Unable to write to Folder Settings because no resource is provided.");case 7:return u("errorInvalidResourceLanguageConfiguration","Unable to write to Language Settings because {0} is not a resource language setting.",i.key);case 8:return u("errorNoWorkspaceOpened","Unable to write to {0} because no workspace is opened. Please open a workspace first and try again.",this.stringifyTarget(t));case 11:{if(i.workspaceStandAloneConfigurationKey===_)return u("errorInvalidTaskConfiguration","Unable to write into the tasks configuration file. Please open it to correct errors/warnings in it and try again.");if(i.workspaceStandAloneConfigurationKey===$)return u("errorInvalidLaunchConfiguration","Unable to write into the launch configuration file. Please open it to correct errors/warnings in it and try again.");switch(t){case 1:return u("errorInvalidConfiguration","Unable to write into user settings. Please open the user settings to correct errors/warnings in it and try again.");case 2:return u("errorInvalidRemoteConfiguration","Unable to write into remote user settings. Please open the remote user settings to correct errors/warnings in it and try again.");case 3:return u("errorInvalidConfigurationWorkspace","Unable to write into workspace settings. Please open the workspace settings to correct errors/warnings in the file and try again.");case 4:{let r="<<unknown>>";if(i.resource){const n=this.contextService.getWorkspaceFolder(i.resource);n&&(r=n.name)}return u("errorInvalidConfigurationFolder","Unable to write into folder settings. Please open the '{0}' folder settings to correct errors/warnings in it and try again.",r)}default:return""}}case 9:{if(i.workspaceStandAloneConfigurationKey===_)return u("errorTasksConfigurationFileDirty","Unable to write into tasks configuration file because the file has unsaved changes. Please save it first and then try again.");if(i.workspaceStandAloneConfigurationKey===$)return u("errorLaunchConfigurationFileDirty","Unable to write into launch configuration file because the file has unsaved changes. Please save it first and then try again.");switch(t){case 1:return u("errorConfigurationFileDirty","Unable to write into user settings because the file has unsaved changes. Please save the user settings file first and then try again.");case 2:return u("errorRemoteConfigurationFileDirty","Unable to write into remote user settings because the file has unsaved changes. Please save the remote user settings file first and then try again.");case 3:return u("errorConfigurationFileDirtyWorkspace","Unable to write into workspace settings because the file has unsaved changes. Please save the workspace settings file first and then try again.");case 4:{let r="<<unknown>>";if(i.resource){const n=this.contextService.getWorkspaceFolder(i.resource);n&&(r=n.name)}return u("errorConfigurationFileDirtyFolder","Unable to write into folder settings because the file has unsaved changes. Please save the '{0}' folder settings file first and then try again.",r)}default:return""}}case 10:if(i.workspaceStandAloneConfigurationKey===_)return u("errorTasksConfigurationFileModifiedSince","Unable to write into tasks configuration file because the content of the file is newer.");if(i.workspaceStandAloneConfigurationKey===$)return u("errorLaunchConfigurationFileModifiedSince","Unable to write into launch configuration file because the content of the file is newer.");switch(t){case 1:return u("errorConfigurationFileModifiedSince","Unable to write into user settings because the content of the file is newer.");case 2:return u("errorRemoteConfigurationFileModifiedSince","Unable to write into remote user settings because the content of the file is newer.");case 3:return u("errorConfigurationFileModifiedSinceWorkspace","Unable to write into workspace settings because the content of the file is newer.");case 4:return u("errorConfigurationFileModifiedSinceFolder","Unable to write into folder settings because the content of the file is newer.")}case 13:return u("errorUnknown","Unable to write to {0} because of an internal error.",this.stringifyTarget(t))}}stringifyTarget(e){switch(e){case 1:return u("userTarget","User Settings");case 2:return u("remoteUserTarget","Remote User Settings");case 3:return u("workspaceTarget","Workspace Settings");case 4:return u("folderTarget","Folder Settings");default:return""}}defaultResourceValue(e){const t=this.uriIdentityService.extUri.basename(e);switch(t.substr(0,t.length-this.uriIdentityService.extUri.extname(e).length)){case _:return tr;default:return"{}"}}async resolveModelReference(e){return await this.fileService.exists(e)||await this.textFileService.write(e,this.defaultResourceValue(e),{encoding:"utf8"}),this.textModelResolverService.createModelReference(e)}hasParseErrors(e,t){if(t.workspaceStandAloneConfigurationKey&&!t.key)return!1;const i=[];return ui(e,i,{allowTrailingComma:!0,allowEmptyContent:!0}),i.length>0}async validate(e,t,i,r){var o,a;if(this.configurationService.inspect(t.key).policyValue!==void 0)throw this.toConfigurationEditingError(12,e,t);const s=(o=y.as(P.Configuration).getConfigurationProperties()[t.key])==null?void 0:o.scope;if(!t.workspaceStandAloneConfigurationKey&&this.configurationService.keys().default.indexOf(t.key)<0&&!Z.test(t.key)&&t.value!==void 0)throw this.toConfigurationEditingError(0,e,t);if(t.workspaceStandAloneConfigurationKey&&t.workspaceStandAloneConfigurationKey!==_&&(e===1||e===2))throw this.toConfigurationEditingError(4,e,t);if((e===3||e===4)&&this.contextService.getWorkbenchState()===1)throw this.toConfigurationEditingError(8,e,t);if(e===3&&!t.workspaceStandAloneConfigurationKey&&!Z.test(t.key)){if(s===1)throw this.toConfigurationEditingError(1,e,t);if(s===2)throw this.toConfigurationEditingError(2,e,t)}if(e===4){if(!t.resource)throw this.toConfigurationEditingError(6,e,t);if(!t.workspaceStandAloneConfigurationKey&&!Z.test(t.key)&&s!==void 0&&!It.includes(s))throw this.toConfigurationEditingError(3,e,t)}if((a=r.overrideIdentifiers)!=null&&a.length&&s!==5)throw this.toConfigurationEditingError(7,e,t);if(!t.resource)throw this.toConfigurationEditingError(6,e,t);if(i&&this.textFileService.isDirty(t.resource))throw this.toConfigurationEditingError(9,e,t)}getConfigurationEditOperation(e,t,i){var c,h;if(t.key){const d=e===1?rr:sr,p=Object.keys(d);for(const v of p){const F=this.getConfigurationFileResource(e,v,d[v],i.resource,void 0);if(t.key===v){const b=this.isWorkspaceConfigurationResource(F)?[v]:[];return{key:b[b.length-1],jsonPath:b,value:t.value,resource:ie(F),workspaceStandAloneConfigurationKey:v,target:e}}const I=`${v}.`;if(t.key.indexOf(I)===0){const b=this.isWorkspaceConfigurationResource(F)?[v,t.key.substr(I.length)]:[t.key.substr(I.length)];return{key:b[b.length-1],jsonPath:b,value:t.value,resource:ie(F),workspaceStandAloneConfigurationKey:v,target:e}}}}const r=t.key,s=(c=y.as(P.Configuration).getConfigurationProperties()[r])==null?void 0:c.scope;let o=(h=i.overrideIdentifiers)!=null&&h.length?[wt(i.overrideIdentifiers),r]:[r];if(e===1||e===2)return{key:r,jsonPath:o,value:t.value,resource:ie(this.getConfigurationFileResource(e,void 0,"",null,s)),target:e};const a=this.getConfigurationFileResource(e,void 0,ir,i.resource,s);return this.isWorkspaceConfigurationResource(a)&&(o=["settings",...o]),{key:r,jsonPath:o,value:t.value,resource:ie(a),target:e}}isWorkspaceConfigurationResource(e){const t=this.contextService.getWorkspace();return!!(t.configuration&&e&&t.configuration.fsPath===e.fsPath)}getConfigurationFileResource(e,t,i,r,n){if(e===1)return t===_?this.userDataProfileService.currentProfile.tasksResource:n===1&&!this.userDataProfileService.currentProfile.isDefault?this.userDataProfilesService.defaultProfile.settingsResource:this.userDataProfileService.currentProfile.settingsResource;if(e===2)return this.remoteSettingsResource;const s=this.contextService.getWorkbenchState();if(s!==1){const o=this.contextService.getWorkspace();if(e===3){if(s===3)return hi(o.configuration);if(s===2)return o.folders[0].toResource(i)}if(e===4&&r){const a=this.contextService.getWorkspaceFolder(r);if(a)return a.toResource(i)}}return null}};Ee=E([f(1,ze),f(2,T),f(3,Le),f(4,G),f(5,O),f(6,oi),f(7,ct),f(8,Ct),f(9,Tt),f(10,Lt),f(11,ge)],Ee);class K extends li{constructor(e,t){var i;super(),this.configurationCache=e,this.configurationRegistry=y.as(P.Configuration),this.cachedConfigurationDefaultsOverrides={},this.cacheKey={type:"defaults",key:"configurationDefaultsOverrides"},this.updateCache=!1,(i=t.options)!=null&&i.configurationDefaults&&this.configurationRegistry.registerDefaultConfigurations([{overrides:t.options.configurationDefaults}])}getConfigurationDefaultOverrides(){return this.cachedConfigurationDefaultsOverrides}async initialize(){return await this.initializeCachedConfigurationDefaultsOverrides(),super.initialize()}reload(){return this.updateCache=!0,this.cachedConfigurationDefaultsOverrides={},this.updateCachedConfigurationDefaultsOverrides(),super.reload()}hasCachedConfigurationDefaultsOverrides(){return!di(this.cachedConfigurationDefaultsOverrides)}initializeCachedConfigurationDefaultsOverrides(){return this.initiaizeCachedConfigurationDefaultsOverridesPromise||(this.initiaizeCachedConfigurationDefaultsOverridesPromise=(async()=>{try{if(window.localStorage.getItem(K.DEFAULT_OVERRIDES_CACHE_EXISTS_KEY)){const e=await this.configurationCache.read(this.cacheKey);e&&(this.cachedConfigurationDefaultsOverrides=JSON.parse(e))}}catch{}this.cachedConfigurationDefaultsOverrides=kt(this.cachedConfigurationDefaultsOverrides)?this.cachedConfigurationDefaultsOverrides:{}})()),this.initiaizeCachedConfigurationDefaultsOverridesPromise}onDidUpdateConfiguration(e,t){super.onDidUpdateConfiguration(e,t),t&&this.updateCachedConfigurationDefaultsOverrides()}async updateCachedConfigurationDefaultsOverrides(){if(!this.updateCache)return;const e={},t=this.configurationRegistry.getConfigurationDefaultsOverrides();for(const[i,r]of t)!Z.test(i)&&r.value!==void 0&&(e[i]=r.value);try{Object.keys(e).length?(window.localStorage.setItem(K.DEFAULT_OVERRIDES_CACHE_EXISTS_KEY,"yes"),await this.configurationCache.write(this.cacheKey,JSON.stringify(e))):(window.localStorage.removeItem(K.DEFAULT_OVERRIDES_CACHE_EXISTS_KEY),await this.configurationCache.remove(this.cacheKey))}catch{}}}K.DEFAULT_OVERRIDES_CACHE_EXISTS_KEY="DefaultOverridesCacheExists";class tt extends k{get hasTasksLoaded(){return this.userConfiguration.value instanceof de}constructor(e,t,i,r,n,s){super(),this.settingsResource=e,this.tasksResource=t,this.fileService=r,this.uriIdentityService=n,this.logService=s,this._onDidChangeConfiguration=this._register(new S),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this.userConfiguration=this._register(new He),this.userConfigurationChangeDisposable=this._register(new He),this.configurationParseOptions={scopes:i,skipRestricted:!1},this.userConfiguration.value=new fi(e,i,n.extUri,this.fileService),this.userConfigurationChangeDisposable.value=this.userConfiguration.value.onDidChange(()=>this.reloadConfigurationScheduler.schedule()),this.reloadConfigurationScheduler=this._register(new $e(()=>this.userConfiguration.value.loadConfiguration().then(o=>this._onDidChangeConfiguration.fire(o)),50))}async reset(e,t,i){this.settingsResource=e,this.tasksResource=t,this.configurationParseOptions={scopes:i,skipRestricted:!1};const r=this.uriIdentityService.extUri.dirname(this.settingsResource),n=this.tasksResource?[[_,this.tasksResource]]:[],s=new de(r.toString(),this.settingsResource,n,this.configurationParseOptions,this.fileService,this.uriIdentityService,this.logService),o=await s.loadConfiguration();return this.userConfiguration.value=s,this.userConfigurationChangeDisposable.value&&(this.userConfigurationChangeDisposable.value=this.userConfiguration.value.onDidChange(()=>this.reloadConfigurationScheduler.schedule())),o}async initialize(){return this.userConfiguration.value.loadConfiguration()}async reload(){return this.hasTasksLoaded?this.userConfiguration.value.loadConfiguration():this.reset(this.settingsResource,this.tasksResource,this.configurationParseOptions.scopes)}reparse(){return this.userConfiguration.value.reparse(this.configurationParseOptions)}getRestrictedSettings(){return this.userConfiguration.value.getRestrictedSettings()}}class de extends k{constructor(e,t,i,r,n,s,o){super(),this.settingsResource=t,this.standAloneConfigurationResources=i,this.fileService=n,this.uriIdentityService=s,this.logService=o,this._onDidChange=this._register(new S),this.onDidChange=this._onDidChange.event,this.allResources=[this.settingsResource,...this.standAloneConfigurationResources.map(([,a])=>a)],this._register(Be(...this.allResources.map(a=>Be(this.fileService.watch(s.extUri.dirname(a)),this.fileService.watch(a))))),this._folderSettingsModelParser=new M(e),this._folderSettingsParseOptions=r,this._standAloneConfigurations=[],this._cache=new w,this._register(R.debounce(R.any(R.filter(this.fileService.onDidFilesChange,a=>this.handleFileChangesEvent(a)),R.filter(this.fileService.onDidRunOperation,a=>this.handleFileOperationEvent(a))),()=>{},100)(()=>this._onDidChange.fire()))}async resolveContents(){const e=async r=>Promise.all(r.map(async n=>{try{return(await this.fileService.readFile(n)).value.toString()}catch(s){this.logService.trace(`Error while resolving configuration file '${n.toString()}': ${pi(s)}`),s.fileOperationResult!==1&&s.fileOperationResult!==9&&this.logService.error(s)}return"{}"})),[[t],i]=await Promise.all([e([this.settingsResource]),e(this.standAloneConfigurationResources.map(([,r])=>r))]);return[t,i.map((r,n)=>[this.standAloneConfigurationResources[n][0],r])]}async loadConfiguration(){const[e,t]=await this.resolveContents();this._standAloneConfigurations=[],this._folderSettingsModelParser.parse("",this._folderSettingsParseOptions),e!==void 0&&this._folderSettingsModelParser.parse(e,this._folderSettingsParseOptions);for(let i=0;i<t.length;i++){const r=t[i][1];if(r!==void 0){const n=new Ut(this.standAloneConfigurationResources[i][1].toString(),this.standAloneConfigurationResources[i][0]);n.parse(r),this._standAloneConfigurations.push(n.configurationModel)}}return this.consolidate(),this._cache}getRestrictedSettings(){return this._folderSettingsModelParser.restrictedConfigurations}reparse(e){const t=this._folderSettingsModelParser.configurationModel.contents;return this._folderSettingsParseOptions=e,this._folderSettingsModelParser.reparse(this._folderSettingsParseOptions),q(t,this._folderSettingsModelParser.configurationModel.contents)||this.consolidate(),this._cache}consolidate(){this._cache=this._folderSettingsModelParser.configurationModel.merge(...this._standAloneConfigurations)}handleFileChangesEvent(e){return!!(this.allResources.some(t=>e.contains(t))||this.allResources.some(t=>e.contains(this.uriIdentityService.extUri.dirname(t),2)))}handleFileOperationEvent(e){return!!((e.isOperation(0)||e.isOperation(3)||e.isOperation(1)||e.isOperation(4))&&this.allResources.some(t=>this.uriIdentityService.extUri.isEqual(e.resource,t))||e.isOperation(1)&&this.allResources.some(t=>this.uriIdentityService.extUri.isEqual(e.resource,this.uriIdentityService.extUri.dirname(t))))}}class kr extends k{constructor(e,t,i,r,n){super(),this._userConfigurationInitializationPromise=null,this._onDidChangeConfiguration=this._register(new S),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this._onDidInitialize=this._register(new S),this.onDidInitialize=this._onDidInitialize.event,this._fileService=i,this._userConfiguration=this._cachedConfiguration=new Sr(e,t,{scopes:be}),n.getEnvironment().then(async s=>{if(s){const o=this._register(new We(s.settingsPath,{scopes:be},this._fileService,r));this._register(o.onDidChangeConfiguration(c=>this.onDidUserConfigurationChange(c))),this._userConfigurationInitializationPromise=o.initialize();const a=await this._userConfigurationInitializationPromise;this._userConfiguration.dispose(),this._userConfiguration=o,this.onDidUserConfigurationChange(a),this._onDidInitialize.fire(a)}})}async initialize(){if(this._userConfiguration instanceof We)return this._userConfiguration.initialize();let e=await this._userConfiguration.initialize();return this._userConfigurationInitializationPromise&&(e=await this._userConfigurationInitializationPromise,this._userConfigurationInitializationPromise=null),e}reload(){return this._userConfiguration.reload()}reparse(){return this._userConfiguration.reparse({scopes:be})}getRestrictedSettings(){return this._userConfiguration.getRestrictedSettings()}onDidUserConfigurationChange(e){this.updateCache(),this._onDidChangeConfiguration.fire(e)}async updateCache(){if(this._userConfiguration instanceof We){let e;try{e=await this._userConfiguration.resolveContent()}catch(t){if(t.fileOperationResult!==1)return}await this._cachedConfiguration.updateConfiguration(e)}}}class We extends k{constructor(e,t,i,r){super(),this.configurationResource=e,this.fileService=i,this.uriIdentityService=r,this._onDidChangeConfiguration=this._register(new S),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this.fileWatcherDisposable=k.None,this.directoryWatcherDisposable=k.None,this.parser=new M(this.configurationResource.toString()),this.parseOptions=t,this._register(i.onDidFilesChange(n=>this.handleFileChangesEvent(n))),this._register(i.onDidRunOperation(n=>this.handleFileOperationEvent(n))),this.reloadConfigurationScheduler=this._register(new $e(()=>this.reload().then(n=>this._onDidChangeConfiguration.fire(n)),50)),this._register(gi(()=>{this.stopWatchingResource(),this.stopWatchingDirectory()}))}watchResource(){this.fileWatcherDisposable=this.fileService.watch(this.configurationResource)}stopWatchingResource(){this.fileWatcherDisposable.dispose(),this.fileWatcherDisposable=k.None}watchDirectory(){const e=this.uriIdentityService.extUri.dirname(this.configurationResource);this.directoryWatcherDisposable=this.fileService.watch(e)}stopWatchingDirectory(){this.directoryWatcherDisposable.dispose(),this.directoryWatcherDisposable=k.None}async initialize(){const e=await this.fileService.exists(this.configurationResource);return this.onResourceExists(e),this.reload()}async resolveContent(){return(await this.fileService.readFile(this.configurationResource)).value.toString()}async reload(){try{const e=await this.resolveContent();return this.parser.parse(e,this.parseOptions),this.parser.configurationModel}catch{return new w}}reparse(e){return this.parseOptions=e,this.parser.reparse(this.parseOptions),this.parser.configurationModel}getRestrictedSettings(){return this.parser.restrictedConfigurations}handleFileChangesEvent(e){let t=e.contains(this.configurationResource,0);e.contains(this.configurationResource,1)?(t=!0,this.onResourceExists(!0)):e.contains(this.configurationResource,2)&&(t=!0,this.onResourceExists(!1)),t&&this.reloadConfigurationScheduler.schedule()}handleFileOperationEvent(e){(e.isOperation(0)||e.isOperation(3)||e.isOperation(1)||e.isOperation(4))&&this.uriIdentityService.extUri.isEqual(e.resource,this.configurationResource)&&this.reloadConfigurationScheduler.schedule()}onResourceExists(e){e?(this.stopWatchingDirectory(),this.watchResource()):(this.stopWatchingResource(),this.watchDirectory())}}class Sr extends k{constructor(e,t,i){super(),this.configurationCache=t,this._onDidChange=this._register(new S),this.onDidChange=this._onDidChange.event,this.key={type:"user",key:e},this.parser=new M("CachedRemoteUserConfiguration"),this.parseOptions=i,this.configurationModel=new w}getConfigurationModel(){return this.configurationModel}initialize(){return this.reload()}reparse(e){return this.parseOptions=e,this.parser.reparse(this.parseOptions),this.configurationModel=this.parser.configurationModel,this.configurationModel}getRestrictedSettings(){return this.parser.restrictedConfigurations}async reload(){try{const e=await this.configurationCache.read(this.key),t=JSON.parse(e);t.content&&(this.parser.parse(t.content,this.parseOptions),this.configurationModel=this.parser.configurationModel)}catch{}return this.configurationModel}async updateConfiguration(e){return e?this.configurationCache.write(this.key,JSON.stringify({content:e})):this.configurationCache.remove(this.key)}}class vr extends k{get initialized(){return this._initialized}constructor(e,t,i,r){super(),this.configurationCache=e,this.fileService=t,this.uriIdentityService=i,this.logService=r,this._workspaceConfigurationDisposables=this._register(new St),this._workspaceIdentifier=null,this._isWorkspaceTrusted=!1,this._onDidUpdateConfiguration=this._register(new S),this.onDidUpdateConfiguration=this._onDidUpdateConfiguration.event,this._initialized=!1,this.fileService=t,this._workspaceConfiguration=this._cachedConfiguration=new mr(e)}async initialize(e,t){this._workspaceIdentifier=e,this._isWorkspaceTrusted=t,this._initialized||(this.configurationCache.needsCaching(this._workspaceIdentifier.configPath)?(this._workspaceConfiguration=this._cachedConfiguration,this.waitAndInitialize(this._workspaceIdentifier)):this.doInitialize(new re(this.fileService,this.uriIdentityService,this.logService))),await this.reload()}async reload(){this._workspaceIdentifier&&await this._workspaceConfiguration.load(this._workspaceIdentifier,{scopes:ne,skipRestricted:this.isUntrusted()})}getFolders(){return this._workspaceConfiguration.getFolders()}setFolders(e,t){return this._workspaceIdentifier?t.write(this._workspaceIdentifier.configPath,[{path:["folders"],value:e}],!0).then(()=>this.reload()):Promise.resolve()}isTransient(){return this._workspaceConfiguration.isTransient()}getConfiguration(){return this._workspaceConfiguration.getWorkspaceSettings()}updateWorkspaceTrust(e){return this._isWorkspaceTrusted=e,this.reparseWorkspaceSettings()}reparseWorkspaceSettings(){return this._workspaceConfiguration.reparseWorkspaceSettings({scopes:ne,skipRestricted:this.isUntrusted()}),this.getConfiguration()}getRestrictedSettings(){return this._workspaceConfiguration.getRestrictedSettings()}async waitAndInitialize(e){if(await vt(e.configPath,this.fileService),!(this._workspaceConfiguration instanceof re)){const t=this._register(new re(this.fileService,this.uriIdentityService,this.logService));await t.load(e,{scopes:ne,skipRestricted:this.isUntrusted()}),this.doInitialize(t),this.onDidWorkspaceConfigurationChange(!1,!0)}}doInitialize(e){this._workspaceConfigurationDisposables.clear(),this._workspaceConfiguration=this._workspaceConfigurationDisposables.add(e),this._workspaceConfigurationDisposables.add(this._workspaceConfiguration.onDidChange(t=>this.onDidWorkspaceConfigurationChange(!0,!1))),this._initialized=!0}isUntrusted(){return!this._isWorkspaceTrusted}async onDidWorkspaceConfigurationChange(e,t){e&&await this.reload(),this.updateCache(),this._onDidUpdateConfiguration.fire(t)}async updateCache(){if(this._workspaceIdentifier&&this.configurationCache.needsCaching(this._workspaceIdentifier.configPath)&&this._workspaceConfiguration instanceof re){const e=await this._workspaceConfiguration.resolveContent(this._workspaceIdentifier);await this._cachedConfiguration.updateWorkspace(this._workspaceIdentifier,e)}}}class re extends k{constructor(e,t,i){super(),this.fileService=e,this.logService=i,this._workspaceIdentifier=null,this._onDidChange=this._register(new S),this.onDidChange=this._onDidChange.event,this.workspaceConfigurationModelParser=new le(""),this.workspaceSettings=new w,this._register(R.any(R.filter(this.fileService.onDidFilesChange,r=>!!this._workspaceIdentifier&&r.contains(this._workspaceIdentifier.configPath)),R.filter(this.fileService.onDidRunOperation,r=>!!this._workspaceIdentifier&&(r.isOperation(0)||r.isOperation(3)||r.isOperation(1)||r.isOperation(4))&&t.extUri.isEqual(r.resource,this._workspaceIdentifier.configPath)))(()=>this.reloadConfigurationScheduler.schedule())),this.reloadConfigurationScheduler=this._register(new $e(()=>this._onDidChange.fire(),50)),this.workspaceConfigWatcher=this._register(this.watchWorkspaceConfigurationFile())}get workspaceIdentifier(){return this._workspaceIdentifier}async resolveContent(e){return(await this.fileService.readFile(e.configPath)).value.toString()}async load(e,t){(!this._workspaceIdentifier||this._workspaceIdentifier.id!==e.id)&&(this._workspaceIdentifier=e,this.workspaceConfigurationModelParser=new le(this._workspaceIdentifier.id),mt(this.workspaceConfigWatcher),this.workspaceConfigWatcher=this._register(this.watchWorkspaceConfigurationFile()));let i="";try{i=await this.resolveContent(this._workspaceIdentifier)}catch(r){await this.fileService.exists(this._workspaceIdentifier.configPath)&&this.logService.error(r)}this.workspaceConfigurationModelParser.parse(i,t),this.consolidate()}getConfigurationModel(){return this.workspaceConfigurationModelParser.configurationModel}getFolders(){return this.workspaceConfigurationModelParser.folders}isTransient(){return this.workspaceConfigurationModelParser.transient}getWorkspaceSettings(){return this.workspaceSettings}reparseWorkspaceSettings(e){return this.workspaceConfigurationModelParser.reparseWorkspaceSettings(e),this.consolidate(),this.getWorkspaceSettings()}getRestrictedSettings(){return this.workspaceConfigurationModelParser.getRestrictedWorkspaceSettings()}consolidate(){this.workspaceSettings=this.workspaceConfigurationModelParser.settingsModel.merge(this.workspaceConfigurationModelParser.launchModel,this.workspaceConfigurationModelParser.tasksModel)}watchWorkspaceConfigurationFile(){return this._workspaceIdentifier?this.fileService.watch(this._workspaceIdentifier.configPath):k.None}}class mr{constructor(e){this.configurationCache=e,this.onDidChange=R.None,this.workspaceConfigurationModelParser=new le(""),this.workspaceSettings=new w}async load(e,t){try{const i=this.getKey(e),r=await this.configurationCache.read(i),n=JSON.parse(r);n.content&&(this.workspaceConfigurationModelParser=new le(i.key),this.workspaceConfigurationModelParser.parse(n.content,t),this.consolidate())}catch{}}get workspaceIdentifier(){return null}getConfigurationModel(){return this.workspaceConfigurationModelParser.configurationModel}getFolders(){return this.workspaceConfigurationModelParser.folders}isTransient(){return this.workspaceConfigurationModelParser.transient}getWorkspaceSettings(){return this.workspaceSettings}reparseWorkspaceSettings(e){return this.workspaceConfigurationModelParser.reparseWorkspaceSettings(e),this.consolidate(),this.getWorkspaceSettings()}getRestrictedSettings(){return this.workspaceConfigurationModelParser.getRestrictedWorkspaceSettings()}consolidate(){this.workspaceSettings=this.workspaceConfigurationModelParser.settingsModel.merge(this.workspaceConfigurationModelParser.launchModel,this.workspaceConfigurationModelParser.tasksModel)}async updateWorkspace(e,t){try{const i=this.getKey(e);t?await this.configurationCache.write(i,JSON.stringify({content:t})):await this.configurationCache.remove(i)}catch{}}getKey(e){return{type:"workspaces",key:e.id}}}class yr{constructor(e,t,i,r){this.configurationCache=r,this.onDidChange=R.None,this.key={type:"folder",key:yt(H(e,t).toString()).toString(16)},this._folderSettingsModelParser=new M("CachedFolderConfiguration"),this._folderSettingsParseOptions=i,this._standAloneConfigurations=[],this.configurationModel=new w}async loadConfiguration(){try{const e=await this.configurationCache.read(this.key),{content:t}=JSON.parse(e.toString());if(t)for(const i of Object.keys(t))if(i===Pe)this._folderSettingsModelParser.parse(t[i],this._folderSettingsParseOptions);else{const r=new Ut(i,i);r.parse(t[i]),this._standAloneConfigurations.push(r.configurationModel)}this.consolidate()}catch{}return this.configurationModel}async updateConfiguration(e,t){const i={};e&&(i[Pe]=e),t.forEach(([r,n])=>{n&&(i[r]=n)}),Object.keys(i).length?await this.configurationCache.write(this.key,JSON.stringify({content:i})):await this.configurationCache.remove(this.key)}getRestrictedSettings(){return this._folderSettingsModelParser.restrictedConfigurations}reparse(e){return this._folderSettingsParseOptions=e,this._folderSettingsModelParser.reparse(this._folderSettingsParseOptions),this.consolidate(),this.configurationModel}consolidate(){this.configurationModel=this._folderSettingsModelParser.configurationModel.merge(...this._standAloneConfigurations)}getUnsupportedKeys(){return[]}}class br extends k{constructor(e,t,i,r,n,s,o,a,c){super(),this.workspaceFolder=t,this.workbenchState=r,this.workspaceTrusted=n,this.configurationCache=c,this._onDidChange=this._register(new S),this.onDidChange=this._onDidChange.event,this.scopes=this.workbenchState===3?It:ne,this.configurationFolder=o.extUri.joinPath(t.uri,i),this.cachedFolderConfiguration=new yr(t.uri,i,{scopes:this.scopes,skipRestricted:this.isUntrusted()},c),e&&this.configurationCache.needsCaching(t.uri)?(this.folderConfiguration=this.cachedFolderConfiguration,vt(t.uri,s).then(()=>{this.folderConfiguration=this._register(this.createFileServiceBasedConfiguration(s,o,a)),this._register(this.folderConfiguration.onDidChange(h=>this.onDidFolderConfigurationChange())),this.onDidFolderConfigurationChange()})):(this.folderConfiguration=this._register(this.createFileServiceBasedConfiguration(s,o,a)),this._register(this.folderConfiguration.onDidChange(h=>this.onDidFolderConfigurationChange())))}loadConfiguration(){return this.folderConfiguration.loadConfiguration()}updateWorkspaceTrust(e){return this.workspaceTrusted=e,this.reparse()}reparse(){const e=this.folderConfiguration.reparse({scopes:this.scopes,skipRestricted:this.isUntrusted()});return this.updateCache(),e}getRestrictedSettings(){return this.folderConfiguration.getRestrictedSettings()}isUntrusted(){return!this.workspaceTrusted}onDidFolderConfigurationChange(){this.updateCache(),this._onDidChange.fire()}createFileServiceBasedConfiguration(e,t,i){const r=t.extUri.joinPath(this.configurationFolder,`${Pe}.json`),n=[_,$].map(s=>[s,t.extUri.joinPath(this.configurationFolder,`${s}.json`)]);return new de(this.configurationFolder.toString(),r,n,{scopes:this.scopes,skipRestricted:this.isUntrusted()},e,t,i)}async updateCache(){if(this.configurationCache.needsCaching(this.configurationFolder)&&this.folderConfiguration instanceof de){const[e,t]=await this.folderConfiguration.resolveContents();this.cachedFolderConfiguration.updateConfiguration(e,t)}}}function it(l,e){return l.isDefault?e?lr:void 0:e?dr:fr}class _e extends Ii{constructor(){super(...arguments),this.initialized=!1}}class Wr extends k{get restrictedSettings(){return this._restrictedSettings}constructor({remoteAuthority:e,configurationCache:t},i,r,n,s,o,a,c,h){if(super(),this.userDataProfileService=r,this.userDataProfilesService=n,this.fileService=s,this.remoteAgentService=o,this.uriIdentityService=a,this.logService=c,this.initialized=!1,this.applicationConfiguration=null,this.remoteUserConfiguration=null,this._onDidChangeConfiguration=this._register(new S),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this._onWillChangeWorkspaceFolders=this._register(new S),this.onWillChangeWorkspaceFolders=this._onWillChangeWorkspaceFolders.event,this._onDidChangeWorkspaceFolders=this._register(new S),this.onDidChangeWorkspaceFolders=this._onDidChangeWorkspaceFolders.event,this._onDidChangeWorkspaceName=this._register(new S),this.onDidChangeWorkspaceName=this._onDidChangeWorkspaceName.event,this._onDidChangeWorkbenchState=this._register(new S),this.onDidChangeWorkbenchState=this._onDidChangeWorkbenchState.event,this.isWorkspaceTrusted=!0,this._restrictedSettings={default:[]},this._onDidChangeRestrictedSettings=this._register(new S),this.onDidChangeRestrictedSettings=this._onDidChangeRestrictedSettings.event,this.configurationRegistry=y.as(P.Configuration),this.initRemoteUserConfigurationBarrier=new Je,this.completeWorkspaceBarrier=new Je,this.defaultConfiguration=this._register(new K(t,i)),this.policyConfiguration=h instanceof mi?new yi:this._register(new bi(this.defaultConfiguration,h,c)),this.configurationCache=t,this._configuration=new et(this.defaultConfiguration.configurationModel,this.policyConfiguration.configurationModel,new w,new w,new w,new w,new U,new w,new U,this.workspace),this.applicationConfigurationDisposables=this._register(new St),this.createApplicationConfiguration(),this.localUserConfiguration=this._register(new tt(r.currentProfile.settingsResource,r.currentProfile.tasksResource,it(r.currentProfile,!!e),s,a,c)),this.cachedFolderConfigs=new U,this._register(this.localUserConfiguration.onDidChangeConfiguration(d=>this.onLocalUserConfigurationChanged(d))),e){const d=this.remoteUserConfiguration=this._register(new kr(e,t,s,a,o));this._register(d.onDidInitialize(p=>{this._register(d.onDidChangeConfiguration(v=>this.onRemoteUserConfigurationChanged(v))),this.onRemoteUserConfigurationChanged(p),this.initRemoteUserConfigurationBarrier.open()}))}else this.initRemoteUserConfigurationBarrier.open();this.workspaceConfiguration=this._register(new vr(t,s,a,c)),this._register(this.workspaceConfiguration.onDidUpdateConfiguration(d=>{this.onWorkspaceConfigurationChanged(d).then(()=>{this.workspace.initialized=this.workspaceConfiguration.initialized,this.checkAndMarkWorkspaceComplete(d)})})),this._register(this.defaultConfiguration.onDidChangeConfiguration(({properties:d,defaults:p})=>this.onDefaultConfigurationChanged(p,d))),this._register(this.policyConfiguration.onDidChangeConfiguration(d=>this.onPolicyConfigurationChanged(d))),this._register(r.onDidChangeCurrentProfile(d=>this.onUserDataProfileChanged(d))),this.workspaceEditingQueue=new je}createApplicationConfiguration(){this.applicationConfigurationDisposables.clear(),this.userDataProfileService.currentProfile.isDefault?this.applicationConfiguration=null:(this.applicationConfiguration=this.applicationConfigurationDisposables.add(this._register(new tt(this.userDataProfilesService.defaultProfile.settingsResource,void 0,[1],this.fileService,this.uriIdentityService,this.logService))),this.applicationConfigurationDisposables.add(this.applicationConfiguration.onDidChangeConfiguration(e=>this.onApplicationConfigurationChanged(e))))}async getCompleteWorkspace(){return await this.completeWorkspaceBarrier.wait(),this.getWorkspace()}getWorkspace(){return this.workspace}getWorkbenchState(){return this.workspace.configuration?3:this.workspace.folders.length===1?2:1}getWorkspaceFolder(e){return this.workspace.getFolder(e)}addFolders(e,t){return this.updateFolders(e,[],t)}removeFolders(e){return this.updateFolders([],e)}async updateFolders(e,t,i){return this.workspaceEditingQueue.queue(()=>this.doUpdateFolders(e,t,i))}isInsideWorkspace(e){return!!this.getWorkspaceFolder(e)}isCurrentWorkspace(e){switch(this.getWorkbenchState()){case 2:{let t;return A.isUri(e)?t=e:ue(e)&&(t=e.uri),A.isUri(t)&&this.uriIdentityService.extUri.isEqual(t,this.workspace.folders[0].uri)}case 3:return ee(e)&&this.workspace.id===e.id}return!1}async doUpdateFolders(e,t,i){if(this.getWorkbenchState()!==3||e.length+t.length===0)return Promise.resolve(void 0);let r=!1,n=this.getWorkspace().folders,s=n.map(o=>o.raw).filter((o,a)=>$t(o)?!this.contains(t,n[a].uri):!0);if(r=n.length!==s.length,e.length){const o=this.getWorkspace().configuration,a=this.uriIdentityService.extUri.dirname(o);n=Se(s,o,this.uriIdentityService.extUri);const c=n.map(d=>d.uri),h=[];for(const d of e){const p=d.uri;if(!this.contains(c,p)){try{if(!(await this.fileService.stat(p)).isDirectory)continue}catch{}h.push(lt(p,!1,d.name,a,this.uriIdentityService.extUri))}}h.length>0&&(r=!0,typeof i=="number"&&i>=0&&i<s.length?(s=s.slice(0),s.splice(i,0,...h)):s=[...s,...h])}return r?this.setFolders(s):Promise.resolve(void 0)}async setFolders(e){if(!this.instantiationService)throw new Error("Cannot update workspace folders because workspace service is not yet ready to accept writes.");return await this.instantiationService.invokeFunction(t=>this.workspaceConfiguration.setFolders(e,t.get(dt))),this.onWorkspaceConfigurationChanged(!1)}contains(e,t){return e.some(i=>this.uriIdentityService.extUri.isEqual(i,t))}getConfigurationData(){return this._configuration.toData()}getValue(e,t){const i=typeof e=="string"?e:void 0,r=me(e)?e:me(t)?t:void 0;return this._configuration.getValue(i,r)}async updateValue(e,t,i,r,n){const s=Wi(i)?i:me(i)?{resource:i.resource,overrideIdentifiers:i.overrideIdentifier?[i.overrideIdentifier]:void 0}:void 0,o=s?r:i,a=o?[o]:[];if(s!=null&&s.overrideIdentifiers&&(s.overrideIdentifiers=ce(s.overrideIdentifiers),s.overrideIdentifiers=s.overrideIdentifiers.length?s.overrideIdentifiers:void 0),!a.length){if(s!=null&&s.overrideIdentifiers&&s.overrideIdentifiers.length>1)throw new Error("Configuration Target is required while updating the value for multiple override identifiers");const c=this.inspect(e,{resource:s==null?void 0:s.resource,overrideIdentifier:s!=null&&s.overrideIdentifiers?s.overrideIdentifiers[0]:void 0});a.push(...this.deriveConfigurationTargets(e,t,c)),q(t,c.defaultValue)&&a.length===1&&(a[0]===2||a[0]===3)&&(t=void 0)}await Ye.settled(a.map(c=>this.writeConfigurationValue(e,t,c,s,n)))}async reloadConfiguration(e){if(e===void 0){this.reloadDefaultConfiguration();const t=await this.reloadApplicationConfiguration(!0),{local:i,remote:r}=await this.reloadUserConfiguration();await this.reloadWorkspaceConfiguration(),await this.loadConfiguration(t,i,r,!0);return}if(_i(e)){await this.reloadWorkspaceFolderConfiguration(e);return}switch(e){case 7:this.reloadDefaultConfiguration();return;case 2:{const{local:t,remote:i}=await this.reloadUserConfiguration();await this.loadConfiguration(this._configuration.applicationConfiguration,t,i,!0);return}case 3:await this.reloadLocalUserConfiguration();return;case 4:await this.reloadRemoteUserConfiguration();return;case 5:case 6:await this.reloadWorkspaceConfiguration();return}}hasCachedConfigurationDefaultsOverrides(){return this.defaultConfiguration.hasCachedConfigurationDefaultsOverrides()}inspect(e,t){return this._configuration.inspect(e,t)}keys(){return this._configuration.keys()}async whenRemoteConfigurationLoaded(){await this.initRemoteUserConfigurationBarrier.wait()}async initialize(e){N("code/willInitWorkspaceService");const t=this.initialized;this.initialized=!1;const i=await this.createWorkspace(e);await this.updateWorkspaceAndInitializeConfiguration(i,t),this.checkAndMarkWorkspaceComplete(!1),N("code/didInitWorkspaceService")}updateWorkspaceTrust(e){var t;if(this.isWorkspaceTrusted!==e){this.isWorkspaceTrusted=e;const i=this._configuration.toData(),r=[];for(const s of this.workspace.folders){const o=this.cachedFolderConfigs.get(s.uri);let a;o&&(a=o.updateWorkspaceTrust(this.isWorkspaceTrusted),this._configuration.updateFolderConfiguration(s.uri,a)),r.push(a)}this.getWorkbenchState()===2?r[0]&&this._configuration.updateWorkspaceConfiguration(r[0]):this._configuration.updateWorkspaceConfiguration(this.workspaceConfiguration.updateWorkspaceTrust(this.isWorkspaceTrusted)),this.updateRestrictedSettings();let n=[];this.restrictedSettings.userLocal&&n.push(...this.restrictedSettings.userLocal),this.restrictedSettings.userRemote&&n.push(...this.restrictedSettings.userRemote),this.restrictedSettings.workspace&&n.push(...this.restrictedSettings.workspace),(t=this.restrictedSettings.workspaceFolder)==null||t.forEach(s=>n.push(...s)),n=ce(n),n.length&&this.triggerConfigurationChange({keys:n,overrides:[]},{data:i,workspace:this.workspace},5)}}acquireInstantiationService(e){this.instantiationService=e}async createWorkspace(e){return ee(e)?this.createMultiFolderWorkspace(e):ue(e)?this.createSingleFolderWorkspace(e):this.createEmptyWorkspace(e)}async createMultiFolderWorkspace(e){await this.workspaceConfiguration.initialize({id:e.id,configPath:e.configPath},this.isWorkspaceTrusted);const t=e.configPath,i=Se(this.workspaceConfiguration.getFolders(),t,this.uriIdentityService.extUri),r=e.id,n=new _e(r,i,this.workspaceConfiguration.isTransient(),t,s=>this.uriIdentityService.extUri.ignorePathCasing(s));return n.initialized=this.workspaceConfiguration.initialized,n}createSingleFolderWorkspace(e){const t=new _e(e.id,[Ri(e.uri)],!1,null,i=>this.uriIdentityService.extUri.ignorePathCasing(i));return t.initialized=!0,t}createEmptyWorkspace(e){const t=new _e(e.id,[],!1,null,i=>this.uriIdentityService.extUri.ignorePathCasing(i));return t.initialized=!0,Promise.resolve(t)}checkAndMarkWorkspaceComplete(e){!this.completeWorkspaceBarrier.isOpen()&&this.workspace.initialized&&(this.completeWorkspaceBarrier.open(),this.validateWorkspaceFoldersAndReload(e))}async updateWorkspaceAndInitializeConfiguration(e,t){const i=!!this.workspace;let r,n,s=[];if(i?(r=this.getWorkbenchState(),n=this.workspace.configuration?this.workspace.configuration.fsPath:void 0,s=this.workspace.folders,this.workspace.update(e)):this.workspace=e,await this.initializeConfiguration(t),i){const o=this.getWorkbenchState();r&&o!==r&&this._onDidChangeWorkbenchState.fire(o);const a=this.workspace.configuration?this.workspace.configuration.fsPath:void 0;(n&&a!==n||o!==r)&&this._onDidChangeWorkspaceName.fire();const c=this.compareFolders(s,this.workspace.folders);c&&(c.added.length||c.removed.length||c.changed.length)&&(await this.handleWillChangeWorkspaceFolders(c,!1),this._onDidChangeWorkspaceFolders.fire(c))}this.localUserConfiguration.hasTasksLoaded||this._register(Fi(()=>this.reloadLocalUserConfiguration()))}compareFolders(e,t){const i={added:[],removed:[],changed:[]};i.added=t.filter(r=>!e.some(n=>r.uri.toString()===n.uri.toString()));for(let r=0;r<e.length;r++){const n=e[r];let s=0;for(s=0;s<t.length&&n.uri.toString()!==t[s].uri.toString();s++);s<t.length?(r!==s||n.name!==t[s].name)&&i.changed.push(n):i.removed.push(n)}return i}async initializeConfiguration(e){await this.defaultConfiguration.initialize();const[,t,i]=await Promise.all([this.policyConfiguration.initialize(),this.initializeApplicationConfiguration(),(async()=>{N("code/willInitUserConfiguration");const r=await this.initializeUserConfiguration();return N("code/didInitUserConfiguration"),r})()]);N("code/willInitWorkspaceConfiguration"),await this.loadConfiguration(t,i.local,i.remote,e),N("code/didInitWorkspaceConfiguration")}async initializeApplicationConfiguration(){return this.applicationConfiguration?this.applicationConfiguration.initialize():Promise.resolve(new w)}async initializeUserConfiguration(){const[e,t]=await Promise.all([this.localUserConfiguration.initialize(),this.remoteUserConfiguration?this.remoteUserConfiguration.initialize():Promise.resolve(new w)]);return{local:e,remote:t}}reloadDefaultConfiguration(){this.onDefaultConfigurationChanged(this.defaultConfiguration.reload())}async reloadApplicationConfiguration(e){if(!this.applicationConfiguration)return new w;const t=await this.applicationConfiguration.reload();return e||this.onApplicationConfigurationChanged(t),t}async reloadUserConfiguration(){const[e,t]=await Promise.all([this.reloadLocalUserConfiguration(!0),this.reloadRemoteUserConfiguration(!0)]);return{local:e,remote:t}}async reloadLocalUserConfiguration(e){const t=await this.localUserConfiguration.reload();return e||this.onLocalUserConfigurationChanged(t),t}async reloadRemoteUserConfiguration(e){if(this.remoteUserConfiguration){const t=await this.remoteUserConfiguration.reload();return e||this.onRemoteUserConfigurationChanged(t),t}return new w}async reloadWorkspaceConfiguration(){const e=this.getWorkbenchState();if(e===2)return this.onWorkspaceFolderConfigurationChanged(this.workspace.folders[0]);if(e===3)return this.workspaceConfiguration.reload().then(()=>this.onWorkspaceConfigurationChanged(!1))}reloadWorkspaceFolderConfiguration(e){return this.onWorkspaceFolderConfigurationChanged(e)}async loadConfiguration(e,t,i,r){this.cachedFolderConfigs=new U;const n=this.workspace.folders,s=await this.loadFolderConfigurations(n),o=this.getWorkspaceConfigurationModel(s),a=new U;s.forEach((h,d)=>a.set(n[d].uri,h));const c=this._configuration;if(this._configuration=new et(this.defaultConfiguration.configurationModel,this.policyConfiguration.configurationModel,e,t,i,o,a,new w,new U,this.workspace),this.initialized=!0,r){const h=this._configuration.compare(c);this.triggerConfigurationChange(h,{data:c.toData(),workspace:this.workspace},5)}this.updateRestrictedSettings()}getWorkspaceConfigurationModel(e){switch(this.getWorkbenchState()){case 2:return e[0];case 3:return this.workspaceConfiguration.getConfiguration();default:return new w}}onUserDataProfileChanged(e){e.join((async()=>{const t=[];t.push(this.localUserConfiguration.reset(e.profile.settingsResource,e.profile.tasksResource,it(e.profile,!!this.remoteUserConfiguration))),e.previous.isDefault!==e.profile.isDefault&&(this.createApplicationConfiguration(),this.applicationConfiguration&&t.push(this.reloadApplicationConfiguration(!0)));const[i,r]=await Promise.all(t);await this.loadConfiguration(r??this._configuration.applicationConfiguration,i,this._configuration.remoteUserConfiguration,!0)})())}onDefaultConfigurationChanged(e,t){if(this.workspace){const i=this._configuration.toData(),r=this._configuration.compareAndUpdateDefaultConfiguration(e,t);if(this.applicationConfiguration&&this._configuration.updateApplicationConfiguration(this.applicationConfiguration.reparse()),this.remoteUserConfiguration&&(this._configuration.updateLocalUserConfiguration(this.localUserConfiguration.reparse()),this._configuration.updateRemoteUserConfiguration(this.remoteUserConfiguration.reparse())),this.getWorkbenchState()===2){const n=this.cachedFolderConfigs.get(this.workspace.folders[0].uri);n&&(this._configuration.updateWorkspaceConfiguration(n.reparse()),this._configuration.updateFolderConfiguration(this.workspace.folders[0].uri,n.reparse()))}else{this._configuration.updateWorkspaceConfiguration(this.workspaceConfiguration.reparseWorkspaceSettings());for(const n of this.workspace.folders){const s=this.cachedFolderConfigs.get(n.uri);s&&this._configuration.updateFolderConfiguration(n.uri,s.reparse())}}this.triggerConfigurationChange(r,{data:i,workspace:this.workspace},7),this.updateRestrictedSettings()}}onPolicyConfigurationChanged(e){const t={data:this._configuration.toData(),workspace:this.workspace},i=this._configuration.compareAndUpdatePolicyConfiguration(e);this.triggerConfigurationChange(i,t,7)}onApplicationConfigurationChanged(e){const t={data:this._configuration.toData(),workspace:this.workspace},i=this._configuration.compareAndUpdateApplicationConfiguration(e),r=this.configurationRegistry.getConfigurationProperties();i.keys=i.keys.filter(n=>{var s;return((s=r[n])==null?void 0:s.scope)===1}),this.triggerConfigurationChange(i,t,2)}onLocalUserConfigurationChanged(e){const t={data:this._configuration.toData(),workspace:this.workspace},i=this._configuration.compareAndUpdateLocalUserConfiguration(e);this.triggerConfigurationChange(i,t,2)}onRemoteUserConfigurationChanged(e){const t={data:this._configuration.toData(),workspace:this.workspace},i=this._configuration.compareAndUpdateRemoteUserConfiguration(e);this.triggerConfigurationChange(i,t,2)}async onWorkspaceConfigurationChanged(e){if(this.workspace&&this.workspace.configuration){let t=Se(this.workspaceConfiguration.getFolders(),this.workspace.configuration,this.uriIdentityService.extUri);if(this.workspace.initialized){const{added:i,removed:r,changed:n}=this.compareFolders(this.workspace.folders,t);i.length||r.length||n.length?t=await this.toValidWorkspaceFolders(t):t=this.workspace.folders}await this.updateWorkspaceConfiguration(t,this.workspaceConfiguration.getConfiguration(),e)}}updateRestrictedSettings(){var F,I,b;const e=[],t=this.configurationRegistry.getConfigurationProperties(),i=Object.keys(t).filter(g=>t[g].restricted).sort((g,C)=>g.localeCompare(C)),r=z(i,this._restrictedSettings.default,(g,C)=>g.localeCompare(C));e.push(...r.added,...r.removed);const n=(((F=this.applicationConfiguration)==null?void 0:F.getRestrictedSettings())||[]).sort((g,C)=>g.localeCompare(C)),s=z(n,this._restrictedSettings.application||[],(g,C)=>g.localeCompare(C));e.push(...s.added,...s.removed);const o=this.localUserConfiguration.getRestrictedSettings().sort((g,C)=>g.localeCompare(C)),a=z(o,this._restrictedSettings.userLocal||[],(g,C)=>g.localeCompare(C));e.push(...a.added,...a.removed);const c=(((I=this.remoteUserConfiguration)==null?void 0:I.getRestrictedSettings())||[]).sort((g,C)=>g.localeCompare(C)),h=z(c,this._restrictedSettings.userRemote||[],(g,C)=>g.localeCompare(C));e.push(...h.added,...h.removed);const d=new U;for(const g of this.workspace.folders){const C=this.cachedFolderConfigs.get(g.uri),Ce=((C==null?void 0:C.getRestrictedSettings())||[]).sort((we,ke)=>we.localeCompare(ke));Ce.length&&d.set(g.uri,Ce);const Mt=((b=this._restrictedSettings.workspaceFolder)==null?void 0:b.get(g.uri))||[],Ve=z(Ce,Mt,(we,ke)=>we.localeCompare(ke));e.push(...Ve.added,...Ve.removed)}const p=this.getWorkbenchState()===3?this.workspaceConfiguration.getRestrictedSettings().sort((g,C)=>g.localeCompare(C)):this.workspace.folders[0]?d.get(this.workspace.folders[0].uri)||[]:[],v=z(p,this._restrictedSettings.workspace||[],(g,C)=>g.localeCompare(C));e.push(...v.added,...v.removed),e.length&&(this._restrictedSettings={default:i,application:n.length?n:void 0,userLocal:o.length?o:void 0,userRemote:c.length?c:void 0,workspace:p.length?p:void 0,workspaceFolder:d.size?d:void 0},this._onDidChangeRestrictedSettings.fire(this.restrictedSettings))}async updateWorkspaceConfiguration(e,t,i){const r={data:this._configuration.toData(),workspace:this.workspace},n=this._configuration.compareAndUpdateWorkspaceConfiguration(t),s=this.compareFolders(this.workspace.folders,e);if(s.added.length||s.removed.length||s.changed.length){this.workspace.folders=e;const o=await this.onFoldersChanged();await this.handleWillChangeWorkspaceFolders(s,i),this.triggerConfigurationChange(o,r,6),this._onDidChangeWorkspaceFolders.fire(s)}else this.triggerConfigurationChange(n,r,5);this.updateRestrictedSettings()}async handleWillChangeWorkspaceFolders(e,t){const i=[];this._onWillChangeWorkspaceFolders.fire({join(r){i.push(r)},changes:e,fromCache:t});try{await Ye.settled(i)}catch{}}async onWorkspaceFolderConfigurationChanged(e){const[t]=await this.loadFolderConfigurations([e]),i={data:this._configuration.toData(),workspace:this.workspace},r=this._configuration.compareAndUpdateFolderConfiguration(e.uri,t);if(this.getWorkbenchState()===2){const n=this._configuration.compareAndUpdateWorkspaceConfiguration(t);this.triggerConfigurationChange(Xe(r,n),i,5)}else this.triggerConfigurationChange(r,i,6);this.updateRestrictedSettings()}async onFoldersChanged(){const e=[];for(const i of this.cachedFolderConfigs.keys())this.workspace.folders.filter(r=>r.uri.toString()===i.toString())[0]||(this.cachedFolderConfigs.get(i).dispose(),this.cachedFolderConfigs.delete(i),e.push(this._configuration.compareAndDeleteFolderConfiguration(i)));const t=this.workspace.folders.filter(i=>!this.cachedFolderConfigs.has(i.uri));return t.length&&(await this.loadFolderConfigurations(t)).forEach((r,n)=>{e.push(this._configuration.compareAndUpdateFolderConfiguration(t[n].uri,r))}),Xe(...e)}loadFolderConfigurations(e){return Promise.all([...e.map(t=>{let i=this.cachedFolderConfigs.get(t.uri);return i||(i=new br(!this.initialized,t,hr,this.getWorkbenchState(),this.isWorkspaceTrusted,this.fileService,this.uriIdentityService,this.logService,this.configurationCache),this._register(i.onDidChange(()=>this.onWorkspaceFolderConfigurationChanged(t))),this.cachedFolderConfigs.set(t.uri,this._register(i))),i.loadConfiguration()})])}async validateWorkspaceFoldersAndReload(e){const t=await this.toValidWorkspaceFolders(this.workspace.folders),{removed:i}=this.compareFolders(this.workspace.folders,t);i.length&&await this.updateWorkspaceConfiguration(t,this.workspaceConfiguration.getConfiguration(),e)}async toValidWorkspaceFolders(e){const t=[];for(const i of e){try{if(!(await this.fileService.stat(i.uri)).isDirectory)continue}catch(r){this.logService.warn(`Ignoring the error while validating workspace folder ${i.uri.toString()} - ${Di(r)}`)}t.push(i)}return t}async writeConfigurationValue(e,t,i,r,n){var o,a,c;if(!this.instantiationService)throw new Error("Cannot write configuration because the configuration service is not yet ready to accept writes.");if(i===7)throw new Error("Invalid configuration target");if(i===8){const h={data:this._configuration.toData(),workspace:this.workspace};this._configuration.updateValue(e,t,r),this.triggerConfigurationChange({keys:(o=r==null?void 0:r.overrideIdentifiers)!=null&&o.length?[wt(r.overrideIdentifiers),e]:[e],overrides:(a=r==null?void 0:r.overrideIdentifiers)!=null&&a.length?r.overrideIdentifiers.map(d=>[d,[e]]):[]},h,i);return}const s=this.toEditableConfigurationTarget(i,e);if(!s)throw new Error("Invalid configuration target");if(s===2&&!this.remoteUserConfiguration)throw new Error("Invalid configuration target");switch(this.configurationEditing=this.configurationEditing??this.instantiationService.createInstance(Ee,((c=await this.remoteAgentService.getEnvironment())==null?void 0:c.settingsPath)??null),await this.configurationEditing.writeConfiguration(s,{key:e,value:t},{scopes:r,...n}),s){case 1:this.applicationConfiguration&&this.configurationRegistry.getConfigurationProperties()[e].scope===1?await this.reloadApplicationConfiguration():await this.reloadLocalUserConfiguration();return;case 2:return this.reloadRemoteUserConfiguration().then(()=>{});case 3:return this.reloadWorkspaceConfiguration();case 4:{const h=r&&r.resource?this.workspace.getFolder(r.resource):null;if(h)return this.reloadWorkspaceFolderConfiguration(h)}}}deriveConfigurationTargets(e,t,i){if(q(t,i.value))return[];const r=[];return i.workspaceFolderValue!==void 0&&r.push(6),i.workspaceValue!==void 0&&r.push(5),i.userRemoteValue!==void 0&&r.push(4),i.userLocalValue!==void 0&&r.push(3),t===void 0?r:[r[0]||2]}triggerConfigurationChange(e,t,i){if(e.keys.length){i!==7&&this.logService.debug(`Configuration keys changed in ${Pi(i)} target`,...e.keys);const r=new Ei(e,t,this._configuration,this.workspace);r.source=i,r.sourceConfig=this.getTargetConfiguration(i),this._onDidChangeConfiguration.fire(r)}}getTargetConfiguration(e){switch(e){case 7:return this._configuration.defaults.contents;case 2:return this._configuration.userConfiguration.contents;case 5:return this._configuration.workspaceConfiguration.contents}return{}}toEditableConfigurationTarget(e,t){var i;if(e===2){if(this.remoteUserConfiguration){const r=(i=this.configurationRegistry.getConfigurationProperties()[t])==null?void 0:i.scope;if(r===2||r===6||this.inspect(t).userRemoteValue!==void 0)return 2}return 1}return e===3?1:e===4?2:e===5?3:e===6?4:null}}let Ie=class extends k{constructor(e,t,i,r,n){super(),this.workspaceContextService=e,this.environmentService=t,this.workspaceTrustManagementService=i,this.registerSchemas({defaultSettingsSchema:{},userSettingsSchema:{},profileSettingsSchema:{},machineSettingsSchema:{},workspaceSettingsSchema:{},folderSettingsSchema:{},configDefaultsSchema:{}}),r.whenInstalledExtensionsRegistered().then(()=>{this.registerConfigurationSchemas();const s=y.as(P.Configuration),o=this._register(new Ci(50));this._register(R.any(s.onDidUpdateConfiguration,s.onDidSchemaChange,i.onDidChangeTrust)(()=>o.trigger(()=>this.registerConfigurationSchemas(),n.phase===4?void 0:2500)))})}registerConfigurationSchemas(){const e={properties:W.properties,patternProperties:W.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},t=this.environmentService.remoteAuthority?{properties:Object.assign({},wi.properties,J.properties,L.properties),patternProperties:W.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0}:e,i={properties:Object.assign({},Ge.properties,Y.properties,J.properties,L.properties),patternProperties:W.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},r={properties:Object.assign({},Ge.properties,Y.properties,J.properties,L.properties),patternProperties:W.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},n={properties:Object.assign({},this.checkAndFilterPropertiesRequiringTrust(Y.properties),this.checkAndFilterPropertiesRequiringTrust(J.properties),this.checkAndFilterPropertiesRequiringTrust(L.properties)),patternProperties:W.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},s={properties:Object.keys(W.properties).reduce((c,h)=>(c[h]=Object.assign({deprecationMessage:void 0},W.properties[h]),c),{}),patternProperties:Object.keys(W.patternProperties).reduce((c,h)=>(c[h]=Object.assign({deprecationMessage:void 0},W.patternProperties[h]),c),{}),additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0},o=this.workspaceContextService.getWorkbenchState()===3?{properties:Object.assign({},this.checkAndFilterPropertiesRequiringTrust(Y.properties),this.checkAndFilterPropertiesRequiringTrust(L.properties)),patternProperties:W.patternProperties,additionalProperties:!0,allowTrailingCommas:!0,allowComments:!0}:n,a={type:"object",description:u("configurationDefaults.description","Contribute defaults for configurations"),properties:Object.assign({},Y.properties,J.properties,L.properties),patternProperties:{[ki]:{type:"object",default:{},$ref:Si}},additionalProperties:!1};this.registerSchemas({defaultSettingsSchema:s,userSettingsSchema:t,profileSettingsSchema:i,machineSettingsSchema:r,workspaceSettingsSchema:n,folderSettingsSchema:o,configDefaultsSchema:a})}registerSchemas(e){const t=y.as(Wt.JSONContribution);t.registerSchema(nr,e.defaultSettingsSchema),t.registerSchema(or,e.userSettingsSchema),t.registerSchema(ar,e.profileSettingsSchema),t.registerSchema(cr,e.machineSettingsSchema),t.registerSchema(Ot,e.workspaceSettingsSchema),t.registerSchema(ur,e.folderSettingsSchema),t.registerSchema(_t,e.configDefaultsSchema)}checkAndFilterPropertiesRequiringTrust(e){if(this.workspaceTrustManagementService.isWorkspaceTrusted())return e;const t={};return Object.entries(e).forEach(([i,r])=>{r.restricted||(t[i]=r)}),t}};Ie=E([f(0,T),f(1,te),f(2,bt),f(3,zt),f(4,ut)],Ie);let Oe=class extends k{constructor(e){super(),this.workbenchAssignmentService=e,this.processedExperimentalSettings=new Set,this.configurationRegistry=y.as(P.Configuration),this.processExperimentalSettings(Object.keys(this.configurationRegistry.getConfigurationProperties())),this._register(this.configurationRegistry.onDidUpdateConfiguration(({properties:t})=>this.processExperimentalSettings(t)))}async processExperimentalSettings(e){var r;const t={},i=this.configurationRegistry.getConfigurationProperties();for(const n of e){const s=i[n];if((r=s==null?void 0:s.tags)!=null&&r.includes("experimental")&&!this.processedExperimentalSettings.has(n)){this.processedExperimentalSettings.add(n);try{const o=await this.workbenchAssignmentService.getTreatment(`config.${n}`);!vi(o)&&!q(o,s.default)&&(t[n]=o)}catch{}}}Object.keys(t).length&&this.configurationRegistry.registerDefaultConfigurations([{overrides:t,source:u("experimental","Experiments")}])}};Oe=E([f(0,jt)],Oe);const xt=y.as(ht.Workbench);xt.registerWorkbenchContribution(Ie,3);xt.registerWorkbenchContribution(Oe,3);let Ue=class extends k{constructor(e,t,i){super(),this.configurationService=e,this.modelService=t,this.languageService=i,this._onDidChangeConfiguration=this._register(new S),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this._register(this.configurationService.onDidChangeConfiguration(r=>this._onDidChangeConfiguration.fire(this.toResourceConfigurationChangeEvent(r))))}getValue(e,t,i){return typeof i=="string"?this._getValue(e,xi.isIPosition(t)?t:null,i):this._getValue(e,null,typeof t=="string"?t:void 0)}updateValue(e,t,i,r){var o,a,c,h,d;const n=this.getLanguage(e,null),s=this.configurationService.inspect(t,{resource:e,overrideIdentifier:n});switch(r===void 0&&(r=this.deriveConfigurationTarget(s,n)),r){case 8:return this._updateValue(t,i,r,(o=s.memory)==null?void 0:o.override,e,n);case 6:return this._updateValue(t,i,r,(a=s.workspaceFolder)==null?void 0:a.override,e,n);case 5:return this._updateValue(t,i,r,(c=s.workspace)==null?void 0:c.override,e,n);case 4:return this._updateValue(t,i,r,(h=s.userRemote)==null?void 0:h.override,e,n);default:return this._updateValue(t,i,r,(d=s.userLocal)==null?void 0:d.override,e,n)}}_updateValue(e,t,i,r,n,s){return s&&r!==void 0?this.configurationService.updateValue(e,t,{resource:n,overrideIdentifier:s},i):this.configurationService.updateValue(e,t,{resource:n},i)}deriveConfigurationTarget(e,t){var i,r,n,s,o,a,c,h,d;if(t){if(((i=e.memory)==null?void 0:i.override)!==void 0)return 8;if(((r=e.workspaceFolder)==null?void 0:r.override)!==void 0)return 6;if(((n=e.workspace)==null?void 0:n.override)!==void 0)return 5;if(((s=e.userRemote)==null?void 0:s.override)!==void 0)return 4;if(((o=e.userLocal)==null?void 0:o.override)!==void 0)return 3}return((a=e.memory)==null?void 0:a.value)!==void 0?8:((c=e.workspaceFolder)==null?void 0:c.value)!==void 0?6:((h=e.workspace)==null?void 0:h.value)!==void 0?5:((d=e.userRemote)==null?void 0:d.value)!==void 0?4:3}_getValue(e,t,i){const r=e?this.getLanguage(e,t):void 0;return typeof i>"u"?this.configurationService.getValue({resource:e,overrideIdentifier:r}):this.configurationService.getValue(i,{resource:e,overrideIdentifier:r})}inspect(e,t,i){const r=e?this.getLanguage(e,t):void 0;return this.configurationService.inspect(i,{resource:e,overrideIdentifier:r})}getLanguage(e,t){const i=this.modelService.getModel(e);return i?t?i.getLanguageIdAtPosition(t.lineNumber,t.column):i.getLanguageId():this.languageService.guessLanguageIdByFilepathOrFirstLine(e)}toResourceConfigurationChangeEvent(e){return{affectedKeys:e.affectedKeys,affectsConfiguration:(t,i)=>{const r=t?this.getLanguage(t,null):void 0;return e.affectsConfiguration(i,{resource:t,overrideIdentifier:r})}}}};Ue=E([f(0,ze),f(1,Oi),f(2,Ui)],Ue);var rt;(function(l){l[l.APPLICATION=1]="APPLICATION",l[l.MACHINE=2]="MACHINE",l[l.WINDOW=3]="WINDOW",l[l.RESOURCE=4]="RESOURCE",l[l.LANGUAGE_OVERRIDABLE=5]="LANGUAGE_OVERRIDABLE",l[l.MACHINE_OVERRIDABLE=6]="MACHINE_OVERRIDABLE"})(rt||(rt={}));class _r{constructor(e,t,i){this.donotCacheResourcesWithSchemes=e,this.fileService=i,this.cachedConfigurations=new Map,this.cacheHome=t.cacheHome}needsCaching(e){return!this.donotCacheResourcesWithSchemes.includes(e.scheme)}read(e){return this.getCachedConfiguration(e).read()}write(e,t){return this.getCachedConfiguration(e).save(t)}remove(e){return this.getCachedConfiguration(e).remove()}getCachedConfiguration({type:e,key:t}){const i=`${e}:${t}`;let r=this.cachedConfigurations.get(i);return r||(r=new Rr({type:e,key:t},this.cacheHome,this.fileService),this.cachedConfigurations.set(i,r)),r}}class Rr{constructor({type:e,key:t},i,r){this.fileService=r,this.cachedConfigurationFolderResource=H(i,"CachedConfigurations",e,t),this.cachedConfigurationFileResource=H(this.cachedConfigurationFolderResource,e==="workspaces"?"workspace.json":"configuration.json"),this.queue=new je}async read(){try{return(await this.fileService.readFile(this.cachedConfigurationFileResource)).value.toString()}catch{return""}}async save(e){await this.createCachedFolder()&&await this.queue.queue(async()=>{await this.fileService.writeFile(this.cachedConfigurationFileResource,pe.fromString(e))})}async remove(){try{await this.queue.queue(()=>this.fileService.del(this.cachedConfigurationFolderResource,{recursive:!0,useTrash:!1}))}catch(e){if(e.fileOperationResult!==1)throw e}}async createCachedFolder(){if(await this.fileService.exists(this.cachedConfigurationFolderResource))return!0;try{return await this.fileService.createFolder(this.cachedConfigurationFolderResource),!0}catch{return!1}}}const Fr=Ne.registerExtensionPoint({extensionPoint:"resourceLabelFormatters",jsonSchema:{description:u("vscode.extension.contributes.resourceLabelFormatters","Contributes resource label formatting rules."),type:"array",items:{type:"object",required:["scheme","formatting"],properties:{scheme:{type:"string",description:u("vscode.extension.contributes.resourceLabelFormatters.scheme",'URI scheme on which to match the formatter on. For example "file". Simple glob patterns are supported.')},authority:{type:"string",description:u("vscode.extension.contributes.resourceLabelFormatters.authority","URI authority on which to match the formatter on. Simple glob patterns are supported.")},formatting:{description:u("vscode.extension.contributes.resourceLabelFormatters.formatting","Rules for formatting uri resource labels."),type:"object",properties:{label:{type:"string",description:u("vscode.extension.contributes.resourceLabelFormatters.label","Label rules to display. For example: myLabel:/${path}. ${path}, ${scheme}, ${authority} and ${authoritySuffix} are supported as variables.")},separator:{type:"string",description:u("vscode.extension.contributes.resourceLabelFormatters.separator","Separator to be used in the uri label display. '/' or '' as an example.")},stripPathStartingSeparator:{type:"boolean",description:u("vscode.extension.contributes.resourceLabelFormatters.stripPathStartingSeparator","Controls whether `${path}` substitutions should have starting separator characters stripped.")},tildify:{type:"boolean",description:u("vscode.extension.contributes.resourceLabelFormatters.tildify","Controls if the start of the uri label should be tildified when possible.")},workspaceSuffix:{type:"string",description:u("vscode.extension.contributes.resourceLabelFormatters.formatting.workspaceSuffix","Suffix appended to the workspace label.")}}}}}}}),st=/\//g,Dr=/\$\{(scheme|authoritySuffix|authority|path|(query)\.(.+?))\}/g;function Pr(l){return!!(l&&l[2]===":")}let xe=class{constructor(e){this.formattersDisposables=new Map,Fr.setHandler((t,i)=>{for(const r of i.added)for(const n of r.value){const s={...n};typeof s.formatting.label!="string"&&(s.formatting.label="${authority}${path}"),typeof s.formatting.separator!="string"&&(s.formatting.separator=Ai),!Kt(r.description,"contribLabelFormatterWorkspaceTooltip")&&s.formatting.workspaceTooltip&&(s.formatting.workspaceTooltip=void 0),this.formattersDisposables.set(s,e.registerFormatter(s))}for(const r of i.removed)for(const n of r.value)mt(this.formattersDisposables.get(n))})}};xe=E([f(0,Rt)],xe);y.as(ht.Workbench).registerWorkbenchContribution(xe,3);const nt=50;let Ae=class extends k{constructor(e,t,i,r,n,s){var a,c;super(),this.environmentService=e,this.contextService=t,this.pathService=i,this.remoteAgentService=r,this._onDidChangeFormatters=this._register(new S({leakWarningThreshold:400})),this.onDidChangeFormatters=this._onDidChangeFormatters.event,this.os=Qe,this.userHome=i.defaultUriScheme===D.file?this.pathService.userHome({preferLocal:!0}):void 0;const o=this.storedFormattersMemento=new qt("cachedResourceLabelFormatters2",n);this.storedFormatters=o.getMemento(0,1),this.formatters=((c=(a=this.storedFormatters)==null?void 0:a.formatters)==null?void 0:c.slice())||[],this.resolveRemoteEnvironment()}async resolveRemoteEnvironment(){const e=await this.remoteAgentService.getEnvironment();this.os=(e==null?void 0:e.os)??Qe,this.userHome=await this.pathService.userHome()}findFormatting(e){let t;for(const i of this.formatters)if(i.scheme===e.scheme){if(!i.authority&&(!t||i.priority)){t=i;continue}if(!i.authority)continue;Mi(i.authority.toLowerCase(),e.authority.toLowerCase())&&(!t||!t.authority||i.authority.length>t.authority.length||i.authority.length===t.authority.length&&i.priority)&&(t=i)}return t?t.formatting:void 0}getUriLabel(e,t={}){let i=this.findFormatting(e);i&&t.separator&&(i={...i,separator:t.separator});const r=this.doGetUriLabel(e,i,t);return!i&&t.separator?r.replace(st,t.separator):r}doGetUriLabel(e,t,i={}){if(!t)return Ti(e,{os:this.os,tildify:this.userHome?{userHome:this.userHome}:void 0,relative:i.relative?{noPrefix:i.noPrefix,getWorkspace:()=>this.contextService.getWorkspace(),getWorkspaceFolder:r=>this.contextService.getWorkspaceFolder(r)}:void 0});if(i.relative&&this.contextService){let r=this.contextService.getWorkspaceFolder(e);if(!r){const n=this.contextService.getWorkspace(),s=Dt(n.folders);s&&e.scheme!==s.uri.scheme&&e.path.startsWith(x.sep)&&(r=this.contextService.getWorkspaceFolder(s.uri.with({path:e.path})))}if(r){const n=this.formatUri(r.uri,t,i.noPrefix);let s=this.formatUri(e,t,i.noPrefix),o=0;for(;s[o]&&s[o]===n[o];)o++;if(!s[o]||s[o]===t.separator?s=s.substring(1+o):o===n.length&&r.uri.path===x.sep&&(s=s.substring(o)),this.contextService.getWorkspace().folders.length>1&&!i.noPrefix){const c=(r==null?void 0:r.name)??Li(r.uri);s=s?`${c} • ${s}`:c}return s}}return this.formatUri(e,t,i.noPrefix)}getUriBasenameLabel(e){const t=this.findFormatting(e),i=this.doGetUriLabel(e,t);let r;return(t==null?void 0:t.separator)===ye.sep?r=ye:(t==null?void 0:t.separator)===x.sep?r=x:r=this.os===1?ye:x,r.basename(i)}getWorkspaceLabel(e,t){if(Ni(e)){const i=Pt(e);return ue(i)||ee(i)?this.getWorkspaceLabel(i,t):""}return A.isUri(e)?this.doGetSingleFolderWorkspaceLabel(e,t):ue(e)?this.doGetSingleFolderWorkspaceLabel(e.uri,t):ee(e)?this.doGetWorkspaceLabel(e.configPath,t):""}doGetWorkspaceLabel(e,t){if(Fe(e,this.environmentService))return u("untitledWorkspace","Untitled (Workspace)");if(se(e))return u("temporaryWorkspace","Workspace");let i=he(e);i.endsWith(V)&&(i=i.substr(0,i.length-V.length-1));let r;switch(t==null?void 0:t.verbose){case 0:r=i;break;case 2:r=u("workspaceNameVerbose","{0} (Workspace)",this.getUriLabel(H(zi(e),i)));break;case 1:default:r=u("workspaceName","{0} (Workspace)",i);break}return(t==null?void 0:t.verbose)===0?r:this.appendWorkspaceSuffix(r,e)}doGetSingleFolderWorkspaceLabel(e,t){let i;switch(t==null?void 0:t.verbose){case 2:i=this.getUriLabel(e);break;case 0:case 1:default:i=he(e)||x.sep;break}return(t==null?void 0:t.verbose)===0?i:this.appendWorkspaceSuffix(i,e)}getSeparator(e,t){const i=this.findFormatting(A.from({scheme:e,authority:t}));return(i==null?void 0:i.separator)||x.sep}getHostLabel(e,t){const i=this.findFormatting(A.from({scheme:e,authority:t}));return(i==null?void 0:i.workspaceSuffix)||t||""}getHostTooltip(e,t){const i=this.findFormatting(A.from({scheme:e,authority:t}));return i==null?void 0:i.workspaceTooltip}registerCachedFormatter(e){var r;const t=(r=this.storedFormatters).formatters??(r.formatters=[]);let i=t.findIndex(n=>n.scheme===e.scheme&&n.authority===e.authority);if(i===-1&&t.length>=nt&&(i=nt-1),i===-1)t.unshift(e);else{for(let n=i;n>0;n--)t[n]=t[n-1];t[0]=e}return this.storedFormattersMemento.saveMemento(),this.registerFormatter(e)}registerFormatter(e){return this.formatters.push(e),this._onDidChangeFormatters.fire({scheme:e.scheme}),{dispose:()=>{this.formatters=this.formatters.filter(t=>t!==e),this._onDidChangeFormatters.fire({scheme:e.scheme})}}}formatUri(e,t,i){let r=t.label.replace(Dr,(n,s,o,a)=>{switch(s){case"scheme":return e.scheme;case"authority":return e.authority;case"authoritySuffix":{const c=e.authority.indexOf("+");return c===-1?e.authority:e.authority.slice(c+1)}case"path":return t.stripPathStartingSeparator?e.path.slice(e.path[0]===t.separator?1:0):e.path;default:{if(o==="query"){const{query:c}=e;if(c&&c[0]==="{"&&c[c.length-1]==="}")try{return JSON.parse(c)[a]||""}catch{}}return""}}});return t.normalizeDriveLetter&&Pr(r)&&(r=r.charAt(1).toUpperCase()+r.substr(2)),t.tildify&&!i&&this.userHome&&(r=ji(r,this.userHome.fsPath,this.os)),t.authorityPrefix&&e.authority&&(r=t.authorityPrefix+r),r.replace(st,t.separator)}appendWorkspaceSuffix(e,t){const i=this.findFormatting(t),r=i&&typeof i.workspaceSuffix=="string"?i.workspaceSuffix:void 0;return r?`${e} [${r}]`:e}};Ae=E([f(0,te),f(1,T),f(2,Vt),f(3,ft),f(4,Ft),f(5,ut)],Ae);function Er(l){return{id:Ir(l),configPath:l}}function Ir(l){return yt(l.toString()).toString(16)}let fe=class Q extends k{constructor(e,t,i,r,n,s){super(),this.storageService=e,this.contextService=t,this.logService=i,this.fileService=r,this.environmentService=n,this.uriIdentityService=s,this._onRecentlyOpenedChange=this._register(new S),this.onDidChangeRecentlyOpened=this._onRecentlyOpenedChange.event,this.addWorkspaceToRecentlyOpened(),this.registerListeners()}registerListeners(){this._register(this.storageService.onDidChangeValue(e=>this.onDidChangeStorage(e))),this._register(this.contextService.onDidChangeWorkspaceFolders(e=>this.onDidChangeWorkspaceFolders(e)))}onDidChangeStorage(e){e.key===Q.RECENTLY_OPENED_KEY&&e.scope===-1&&this._onRecentlyOpenedChange.fire()}onDidChangeWorkspaceFolders(e){if(se(this.contextService.getWorkspace()))for(const t of e.added)this.addRecentlyOpened([{folderUri:t.uri}])}addWorkspaceToRecentlyOpened(){const e=this.contextService.getWorkspace(),t=this.environmentService.remoteAuthority;switch(this.contextService.getWorkbenchState()){case 2:this.addRecentlyOpened([{folderUri:e.folders[0].uri,remoteAuthority:t}]);break;case 3:this.addRecentlyOpened([{workspace:{id:e.id,configPath:e.configuration},remoteAuthority:t}]);break}}async getRecentlyOpened(){const e=this.storageService.get(Q.RECENTLY_OPENED_KEY,-1);if(e){const t=Ht(JSON.parse(e),this.logService);return t.workspaces=t.workspaces.filter(i=>!(ve(i)&&i.folderUri.scheme===D.file&&!se(this.contextService.getWorkspace())||Bt(i)&&se(i.workspace.configPath))),t}return{workspaces:[],files:[]}}async addRecentlyOpened(e){const t=await this.getRecentlyOpened();for(const i of e)Gt(i)?(this.doRemoveRecentlyOpened(t,[i.fileUri]),t.files.unshift(i)):ve(i)?(this.doRemoveRecentlyOpened(t,[i.folderUri]),t.workspaces.unshift(i)):(this.doRemoveRecentlyOpened(t,[i.workspace.configPath]),t.workspaces.unshift(i));return this.saveRecentlyOpened(t)}async removeRecentlyOpened(e){const t=await this.getRecentlyOpened();return this.doRemoveRecentlyOpened(t,e),this.saveRecentlyOpened(t)}doRemoveRecentlyOpened(e,t){e.files=e.files.filter(i=>!t.some(r=>r.toString()===i.fileUri.toString())),e.workspaces=e.workspaces.filter(i=>!t.some(r=>r.toString()===(ve(i)?i.folderUri.toString():i.workspace.configPath.toString())))}async saveRecentlyOpened(e){return this.storageService.store(Q.RECENTLY_OPENED_KEY,JSON.stringify(Jt(e)),-1,0)}async clearRecentlyOpened(){this.storageService.remove(Q.RECENTLY_OPENED_KEY,-1)}async enterWorkspace(e){return{workspace:await this.getWorkspaceIdentifier(e)}}async createUntitledWorkspace(e,t){const i=(Date.now()+Math.round(Math.random()*1e3)).toString(),r=H(this.environmentService.untitledWorkspacesHome,`Untitled-${i}.${V}`),n=[];if(e)for(const o of e)n.push(lt(o.uri,!0,o.name,this.environmentService.untitledWorkspacesHome,this.uriIdentityService.extUri));const s={folders:n,remoteAuthority:t};return await this.fileService.writeFile(r,pe.fromString(JSON.stringify(s,null,"	"))),this.getWorkspaceIdentifier(r)}async deleteUntitledWorkspace(e){try{await this.fileService.del(e.configPath)}catch(t){if(t.fileOperationResult!==1)throw t}}async getWorkspaceIdentifier(e){return Er(e)}async getDirtyWorkspaces(){return[]}};fe.RECENTLY_OPENED_KEY="recently.opened";fe=E([f(0,Ft),f(1,T),f(2,Et),f(3,O),f(4,te),f(5,ge)],fe);let Me=class{constructor(e,t,i,r,n,s,o,a,c,h,d,p,v,F,I,b){this.jsonEditingService=e,this.contextService=t,this.configurationService=i,this.notificationService=r,this.commandService=n,this.fileService=s,this.textFileService=o,this.workspacesService=a,this.environmentService=c,this.fileDialogService=h,this.dialogService=d,this.hostService=p,this.uriIdentityService=v,this.workspaceTrustManagementService=F,this.userDataProfilesService=I,this.userDataProfileService=b}async pickNewWorkspacePath(){const e=[D.file];this.environmentService.remoteAuthority&&e.unshift(D.vscodeRemote);let t=await this.fileDialogService.showSaveDialog({saveLabel:Vi(u("save","Save")),title:u("saveWorkspace","Save Workspace"),filters:Ki,defaultUri:H(await this.fileDialogService.defaultWorkspacePath(),this.getNewWorkspaceName()),availableFileSystems:e});if(t)return qi(t)||(t=t.with({path:`${t.path}.${V}`})),t}getNewWorkspaceName(){var i;const e=(i=this.getCurrentWorkspaceIdentifier())==null?void 0:i.configPath;if(e&&Hi(e,this.environmentService))return he(e);const t=Dt(this.contextService.getWorkspace().folders);return t?`${he(t.uri)}.${V}`:`workspace.${V}`}async updateFolders(e,t,i,r){const n=this.contextService.getWorkspace().folders;let s=[];typeof t=="number"&&(s=n.slice(e,e+t).map(h=>h.uri));let o=[];Array.isArray(i)&&(o=i.map(h=>({uri:Ze(h.uri),name:h.name})));const a=s.length>0,c=o.length>0;if(!(!c&&!a))return c&&!a?this.doAddFolders(o,e,r):a&&!c?this.removeFolders(s):this.includesSingleFolderWorkspace(s)?this.createAndEnterWorkspace(o):this.contextService.getWorkbenchState()!==3?this.doAddFolders(o,e,r):this.doUpdateFolders(o,s,e,r)}async doUpdateFolders(e,t,i,r=!1){try{await this.contextService.updateFolders(e,t,i)}catch(n){if(r)throw n;this.handleWorkspaceConfigurationEditingError(n)}}addFolders(e,t=!1){const i=e.map(r=>({uri:Ze(r.uri),name:r.name}));return this.doAddFolders(i,void 0,t)}async doAddFolders(e,t,i=!1){const r=this.contextService.getWorkbenchState(),n=this.environmentService.remoteAuthority;if(n&&(e=e.filter(s=>s.uri.scheme!==D.file&&(s.uri.scheme!==D.vscodeRemote||Bi(s.uri.authority,n)))),r!==3){let s=this.contextService.getWorkspace().folders.map(o=>({uri:o.uri}));return s.splice(typeof t=="number"?t:s.length,0,...e),s=ce(s,o=>this.uriIdentityService.extUri.getComparisonKey(o.uri)),r===1&&s.length===0||r===2&&s.length===1?void 0:this.createAndEnterWorkspace(s)}try{await this.contextService.addFolders(e,t)}catch(s){if(i)throw s;this.handleWorkspaceConfigurationEditingError(s)}}async removeFolders(e,t=!1){if(this.includesSingleFolderWorkspace(e))return this.createAndEnterWorkspace([]);try{await this.contextService.removeFolders(e)}catch(i){if(t)throw i;this.handleWorkspaceConfigurationEditingError(i)}}includesSingleFolderWorkspace(e){if(this.contextService.getWorkbenchState()===2){const t=this.contextService.getWorkspace().folders[0];return e.some(i=>this.uriIdentityService.extUri.isEqual(i,t.uri))}return!1}async createAndEnterWorkspace(e,t){if(t&&!await this.isValidTargetWorkspacePath(t))return;const i=this.environmentService.remoteAuthority,r=await this.workspacesService.createUntitledWorkspace(e,i);if(t)try{await this.saveWorkspaceAs(r,t)}finally{await this.workspacesService.deleteUntitledWorkspace(r)}else t=r.configPath,this.userDataProfileService.currentProfile.isDefault||await this.userDataProfilesService.setProfileForWorkspace(r,this.userDataProfileService.currentProfile);return this.enterWorkspace(t)}async saveAndEnterWorkspace(e){const t=this.getCurrentWorkspaceIdentifier();if(t){if(Gi(t.configPath,e))return this.saveWorkspace(t);if(await this.isValidTargetWorkspacePath(e))return await this.saveWorkspaceAs(t,e),this.enterWorkspace(e)}}async isValidTargetWorkspacePath(e){return!0}async saveWorkspaceAs(e,t){const i=e.configPath;if(!Fe(t,this.environmentService)&&!this.userDataProfileService.currentProfile.isDefault){const a=await this.workspacesService.getWorkspaceIdentifier(t);await this.userDataProfilesService.setProfileForWorkspace(a,this.userDataProfileService.currentProfile)}if(this.uriIdentityService.extUri.isEqual(i,t))return;const n=Fe(i,this.environmentService),s=await this.fileService.readFile(i),o=Ke(s.value.toString(),i,n,t,this.uriIdentityService.extUri);await this.textFileService.create([{resource:t,value:o,options:{overwrite:!0}}]),await this.trustWorkspaceConfiguration(t)}async saveWorkspace(e){const t=e.configPath,i=this.textFileService.files.get(t);if(i){await i.save({force:!0,reason:1});return}if(await this.fileService.exists(t))return;const s=Ke(JSON.stringify({folders:[]},null,"	"),t,!1,t,this.uriIdentityService.extUri);await this.textFileService.create([{resource:t,value:s}])}handleWorkspaceConfigurationEditingError(e){switch(e.code){case 0:this.onInvalidWorkspaceConfigurationFileError();break;default:this.notificationService.error(e.message)}}onInvalidWorkspaceConfigurationFileError(){const e=u("errorInvalidTaskConfiguration","Unable to write into workspace configuration file. Please open the file to correct errors/warnings in it and try again.");this.askToOpenWorkspaceConfigurationFile(e)}askToOpenWorkspaceConfigurationFile(e){this.notificationService.prompt(X.Error,e,[{label:u("openWorkspaceConfigurationFile","Open Workspace Configuration"),run:()=>this.commandService.executeCommand("workbench.action.openWorkspaceConfigFile")}])}async doEnterWorkspace(e){if(this.environmentService.extensionTestsLocationURI)throw new Error("Entering a new workspace is not possible in tests.");const t=await this.workspacesService.getWorkspaceIdentifier(e);return this.contextService.getWorkbenchState()===2&&await this.migrateWorkspaceSettings(t),await this.configurationService.initialize(t),this.workspacesService.enterWorkspace(e)}migrateWorkspaceSettings(e){return this.doCopyWorkspaceSettings(e,t=>t.scope===3)}copyWorkspaceSettings(e){return this.doCopyWorkspaceSettings(e)}doCopyWorkspaceSettings(e,t){const i=y.as(P.Configuration).getConfigurationProperties(),r={};for(const n of this.configurationService.keys().workspace)if(i[n]){if(t&&!t(i[n]))continue;r[n]=this.configurationService.inspect(n).workspaceValue}return this.jsonEditingService.write(e.configPath,[{path:["settings"],value:r}],!0)}async trustWorkspaceConfiguration(e){this.contextService.getWorkbenchState()!==1&&this.workspaceTrustManagementService.isWorkspaceTrusted()&&await this.workspaceTrustManagementService.setUrisTrust([e],!0)}getCurrentWorkspaceIdentifier(){const e=Pt(this.contextService.getWorkspace());if(ee(e))return e}};Me=E([f(0,dt),f(1,T),f(2,gr),f(3,Ct),f(4,$i),f(5,O),f(6,ct),f(7,gt),f(8,te),f(9,Yt),f(10,Xt),f(11,Qt),f(12,ge),f(13,bt),f(14,G),f(15,Le)],Me);const Or=y.as(Wt.JSONContribution),oe=y.as(P.Configuration),ot={type:"object",defaultSnippets:[{body:{title:"",properties:{}}}],properties:{title:{description:u("vscode.extension.contributes.configuration.title","A title for the current category of settings. This label will be rendered in the Settings editor as a subheading. If the title is the same as the extension display name, then the category will be grouped under the main extension heading."),type:"string"},order:{description:u("vscode.extension.contributes.configuration.order","When specified, gives the order of this category of settings relative to other categories."),type:"integer"},properties:{description:u("vscode.extension.contributes.configuration.properties","Description of the configuration properties."),type:"object",propertyNames:{pattern:"\\S+",patternErrorMessage:u("vscode.extension.contributes.configuration.property.empty","Property should not be empty.")},additionalProperties:{anyOf:[{title:u("vscode.extension.contributes.configuration.properties.schema","Schema of the configuration property."),$ref:"http://json-schema.org/draft-07/schema#"},{type:"object",properties:{scope:{type:"string",enum:["application","machine","window","resource","language-overridable","machine-overridable"],default:"window",enumDescriptions:[u("scope.application.description","Configuration that can be configured only in the user settings."),u("scope.machine.description","Configuration that can be configured only in the user settings or only in the remote settings."),u("scope.window.description","Configuration that can be configured in the user, remote or workspace settings."),u("scope.resource.description","Configuration that can be configured in the user, remote, workspace or folder settings."),u("scope.language-overridable.description","Resource configuration that can be configured in language specific settings."),u("scope.machine-overridable.description","Machine configuration that can be configured also in workspace or folder settings.")],markdownDescription:u("scope.description","Scope in which the configuration is applicable. Available scopes are `application`, `machine`, `window`, `resource`, and `machine-overridable`.")},enumDescriptions:{type:"array",items:{type:"string"},description:u("scope.enumDescriptions","Descriptions for enum values")},markdownEnumDescriptions:{type:"array",items:{type:"string"},description:u("scope.markdownEnumDescriptions","Descriptions for enum values in the markdown format.")},enumItemLabels:{type:"array",items:{type:"string"},markdownDescription:u("scope.enumItemLabels","Labels for enum values to be displayed in the Settings editor. When specified, the {0} values still show after the labels, but less prominently.","`enum`")},markdownDescription:{type:"string",description:u("scope.markdownDescription","The description in the markdown format.")},deprecationMessage:{type:"string",description:u("scope.deprecationMessage","If set, the property is marked as deprecated and the given message is shown as an explanation.")},markdownDeprecationMessage:{type:"string",description:u("scope.markdownDeprecationMessage","If set, the property is marked as deprecated and the given message is shown as an explanation in the markdown format.")},editPresentation:{type:"string",enum:["singlelineText","multilineText"],enumDescriptions:[u("scope.singlelineText.description","The value will be shown in an inputbox."),u("scope.multilineText.description","The value will be shown in a textarea.")],default:"singlelineText",description:u("scope.editPresentation","When specified, controls the presentation format of the string setting.")},order:{type:"integer",description:u("scope.order","When specified, gives the order of this setting relative to other settings within the same category. Settings with an order property will be placed before settings without this property set.")},ignoreSync:{type:"boolean",description:u("scope.ignoreSync","When enabled, Settings Sync will not sync the user value of this configuration by default.")}}}]}}}};let m;const At=Ne.registerExtensionPoint({extensionPoint:"configurationDefaults",jsonSchema:{$ref:_t}});At.setHandler((l,{added:e,removed:t})=>{m&&oe.deltaConfiguration(m);const i=m={};if(queueMicrotask(()=>{m===i&&(oe.deltaConfiguration(m),m=void 0)}),t.length){const r=t.map(n=>({overrides:De(n.value),source:{id:n.description.identifier.value,displayName:n.description.displayName}}));m.removedDefaults=r}if(e.length){const r=oe.getConfigurationProperties(),n=[6,3,4,5],s=e.map(o=>{const a=De(o.value);for(const c of Object.keys(a))if(!Z.test(c)){const h=r[c];h!=null&&h.scope&&!n.includes(h.scope)&&(o.collector.warn(u("config.property.defaultConfiguration.warning","Cannot register configuration defaults for '{0}'. Only defaults for machine-overridable, window, resource and language overridable scoped settings are supported.",c)),delete a[c])}return{overrides:a,source:{id:o.description.identifier.value,displayName:o.description.displayName}}});m.addedDefaults=s}});const Ur=Ne.registerExtensionPoint({extensionPoint:"configuration",deps:[At],jsonSchema:{description:u("vscode.extension.contributes.configuration","Contributes configuration settings."),oneOf:[ot,{type:"array",items:ot}]}}),Re=new Ji;Ur.setHandler((l,{added:e,removed:t})=>{if(m??(m={}),t.length){const s=[];for(const o of t)s.push(...Re.get(o.description.identifier)||[]),Re.delete(o.description.identifier);m.removedConfigurations=s}const i=new Set;function r(s,o){var h,d,p;const a=[],c=De(s);return c.title&&typeof c.title!="string"&&o.collector.error(u("invalid.title","'configuration.title' must be a string")),n(c,o),c.id=s.id||o.description.identifier.value,c.extensionInfo={id:o.description.identifier.value,displayName:o.description.displayName},c.restrictedProperties=((d=(h=o.description.capabilities)==null?void 0:h.untrustedWorkspaces)==null?void 0:d.supported)==="limited"?(p=o.description.capabilities)==null?void 0:p.untrustedWorkspaces.restrictedConfigurations:void 0,c.title=c.title||o.description.displayName||o.description.identifier.value,a.push(c),a}function n(s,o){const a=s.properties;if(a){typeof a!="object"&&(o.collector.error(u("invalid.properties","'configuration.properties' must be an object")),s.properties={});for(const h in a){const d=a[h],p=Yi(h,d);if(p){delete a[h],o.collector.warn(p);continue}if(i.has(h)){delete a[h],o.collector.warn(u("config.property.duplicate","Cannot register '{0}'. This property is already registered.",h));continue}if(!kt(d)){delete a[h],o.collector.error(u("invalid.property","configuration.properties property '{0}' must be an object",h));continue}i.add(h),d.scope?d.scope.toString()==="application"?d.scope=1:d.scope.toString()==="machine"?d.scope=2:d.scope.toString()==="resource"?d.scope=4:d.scope.toString()==="machine-overridable"?d.scope=6:d.scope.toString()==="language-overridable"?d.scope=5:d.scope=3:d.scope=3}}const c=s.allOf;if(c){o.collector.error(u("invalid.allOf","'configuration.allOf' is deprecated and should no longer be used. Instead, pass multiple configuration sections as an array to the 'configuration' contribution point."));for(const h of c)n(h,o)}}if(e.length){const s=[];for(const o of e){const a=[],c=o.value;Array.isArray(c)?c.forEach(h=>a.push(...r(h,o))):a.push(...r(c,o)),Re.set(o.description.identifier,a),s.push(...a)}m.addedConfigurations=s}oe.deltaConfiguration(m),m=void 0});Or.registerSchema("vscode://schemas/workspaceConfig",{allowComments:!0,allowTrailingCommas:!0,default:{folders:[{path:""}],settings:{}},required:["folders"],properties:{folders:{minItems:0,uniqueItems:!0,description:u("workspaceConfig.folders.description","List of folders to be loaded in the workspace."),items:{type:"object",defaultSnippets:[{body:{path:"$1"}}],oneOf:[{properties:{path:{type:"string",description:u("workspaceConfig.path.description","A file path. e.g. `/root/folderA` or `./folderA` for a relative path that will be resolved against the location of the workspace file.")},name:{type:"string",description:u("workspaceConfig.name.description","An optional name for the folder. ")}},required:["path"]},{properties:{uri:{type:"string",description:u("workspaceConfig.uri.description","URI of the folder")},name:{type:"string",description:u("workspaceConfig.name.description","An optional name for the folder. ")}},required:["uri"]}]}},settings:{type:"object",default:{},description:u("workspaceConfig.settings.description","Workspace settings"),$ref:Ot},launch:{type:"object",default:{configurations:[],compounds:[]},description:u("workspaceConfig.launch.description","Workspace launch configurations"),$ref:pr},tasks:{type:"object",default:{version:"2.0.0",tasks:[]},description:u("workspaceConfig.tasks.description","Workspace task configurations"),$ref:Cr},extensions:{type:"object",default:{},description:u("workspaceConfig.extensions.description","Workspace extensions"),$ref:"vscode://schemas/extensions"},remoteAuthority:{type:"string",doNotSuggest:!0,description:u("workspaceConfig.remoteAuthority","The remote server where the workspace is located.")},transient:{type:"boolean",doNotSuggest:!0,description:u("workspaceConfig.transient","A transient workspace will disappear when restarting or reloading.")}},errorMessage:u("unknownWorkspaceProperty","Unknown workspace configuration property")});async function qr(l){const e=B.get(G);await B.get(O).writeFile(e.defaultProfile.settingsResource,pe.fromString(l))}async function Hr(){const l=B.get(G);return(await B.get(O).readFile(l.defaultProfile.settingsResource)).value.toString()}function Br(l){const e=B.get(G);return B.get(O).onDidFilesChange(t=>{t.affects(e.defaultProfile.settingsResource)&&l()})}const Gr=y.as(P.Configuration);let Te=class extends Wr{constructor(e,t,i,r,n,s,o,a){const c=new _r([D.file,D.vscodeUserData,D.tmp],e,r);super({configurationCache:c},e,t,i,r,n,s,o,a)}};Te=E([f(0,te),f(1,Le),f(2,G),f(3,O),f(4,ft),f(5,ge),f(6,Et),f(7,Xi)],Te);class xr extends Me{constructor(){super(...arguments),this.enterWorkspace=ii}}let ae=A.file("/workspace");ri(async l=>{const e=l.get(T);e.acquireInstantiationService(l.get(Zi));const t=ae.with({path:"/workspace.code-workspace"});try{const i=l.get(O);await i.createFolder(ae),await i.writeFile(t,pe.fromString(JSON.stringify({folders:[{path:ae.path}]})))}catch{}await e.initialize({id:er(),configPath:t})});const at=Zt(Te);function Yr(l){return ae=l,{...ei(),[Rt.toString()]:new j(Ae,void 0,!0),[ze.toString()]:new j(at),[T.toString()]:new j(at),[Qi.toString()]:new j(Ue),[ti.toString()]:new j(xr),[gt.toString()]:new j(fe,void 0,!0)}}export{rt as ConfigurationScope,Gr as configurationRegistry,Yr as default,Hr as getUserConfiguration,Br as onUserConfigurationChange,qr as updateUserConfiguration};
