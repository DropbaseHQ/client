import{_ as v,h as s,I as g,T as m,i as w}from"./index-5b71d1bd.js";import{ca as f,da as p,iN as R,aM as c,oB as S,aR as T,aY as C,be as x,bf as _,oC as I,af as d,a8 as n,oD as b,b0 as D,oE as P,fu as E}from"./vendor-332432be.js";let a=class extends c{constructor(e,r,o){super(),this._modelService=e,this._textModelService=r,this._undoRedoService=o,this._register(this._modelService.onModelRemoved(t=>{const i=this._undoRedoService.getElements(t.uri);if(!(i.past.length===0&&i.future.length===0)){for(const l of i.past)l instanceof S&&l.setDelegate(this);for(const l of i.future)l instanceof S&&l.setDelegate(this)}}))}prepareUndoRedo(e){const r=e.getMissingModels();if(r.length===0)return c.None;const o=r.map(async t=>{try{return await this._textModelService.createModelReference(t)}catch{return c.None}});return Promise.all(o).then(t=>({dispose:()=>T(t)}))}};a=v([s(0,f),s(1,p),s(2,R)],a);let h=class extends I{constructor(e,r,o,t){super(),this.instantiationService=e,this.textFileService=r,this.fileService=o,this.modelService=t,this.providers=new Map,this.modelsToDispose=new Set}createReferencedObject(e){return this.doCreateReferencedObject(e)}async doCreateReferencedObject(e,r){this.modelsToDispose.delete(e);const o=d.parse(e);if(o.scheme===n.inMemory){if(!this.modelService.getModel(o))throw new Error(`Unable to resolve inMemory resource ${e}`);const i=this.instantiationService.createInstance(m,o);if(this.ensureResolvedModel(i,e))return i}if(o.scheme===n.untitled){const t=await this.textFileService.untitled.resolve({untitledResource:o});if(this.ensureResolvedModel(t,e))return t}if(this.fileService.hasProvider(o)){const t=await this.textFileService.files.resolve(o,{reason:2});if(this.ensureResolvedModel(t,e))return t}if(this.providers.has(o.scheme)){await this.resolveTextModelContent(e);const t=this.instantiationService.createInstance(m,o);if(this.ensureResolvedModel(t,e))return t}if(!r)return await this.fileService.activateProvider(o.scheme),this.doCreateReferencedObject(e,!0);throw new Error(`Unable to resolve resource ${e}`)}ensureResolvedModel(e,r){if(b(e))return!0;throw new Error(`Unable to resolve resource ${r}`)}destroyReferencedObject(e,r){const o=d.parse(e);o.scheme===n.untitled||o.scheme===n.inMemory||(this.modelsToDispose.add(e),(async()=>{try{const t=await r;if(!this.modelsToDispose.has(e)||(t instanceof w&&await this.textFileService.files.canDispose(t),!this.modelsToDispose.has(e)))return;t.dispose()}catch{}finally{this.modelsToDispose.delete(e)}})())}registerTextModelContentProvider(e,r){let o=this.providers.get(e);return o||(o=[],this.providers.set(e,o)),o.unshift(r),D(()=>{const t=this.providers.get(e);if(!t)return;const i=t.indexOf(r);i!==-1&&(t.splice(i,1),t.length===0&&this.providers.delete(e))})}hasTextModelContentProvider(e){return this.providers.get(e)!==void 0}async resolveTextModelContent(e){const r=d.parse(e),o=this.providers.get(r.scheme)||[];for(const t of o){const i=await t.provideTextContent(r);if(i)return i}throw new Error(`Unable to resolve text model content for resource ${e}`)}};h=v([s(0,C),s(1,g),s(2,x),s(3,f)],h);let u=class extends c{get resourceModelCollection(){return this._resourceModelCollection||(this._resourceModelCollection=this.instantiationService.createInstance(h)),this._resourceModelCollection}get asyncModelCollection(){return this._asyncModelCollection||(this._asyncModelCollection=new P(this.resourceModelCollection)),this._asyncModelCollection}constructor(e,r,o,t,i){super(),this.instantiationService=e,this.fileService=r,this.undoRedoService=o,this.modelService=t,this.uriIdentityService=i,this._resourceModelCollection=void 0,this._asyncModelCollection=void 0,this._register(new a(this.modelService,this,this.undoRedoService))}async createModelReference(e){return e=this.uriIdentityService.asCanonicalUri(e),await this.asyncModelCollection.acquire(e.toString())}registerTextModelContentProvider(e,r){return this.resourceModelCollection.registerTextModelContentProvider(e,r)}canHandleResource(e){return this.fileService.hasProvider(e)||e.scheme===n.untitled||e.scheme===n.inMemory?!0:this.resourceModelCollection.hasTextModelContentProvider(e.scheme)}};u=v([s(0,C),s(1,x),s(2,R),s(3,f),s(4,_)],u);function $(){return{[p.toString()]:new E(u,void 0,!0)}}export{$ as default};
